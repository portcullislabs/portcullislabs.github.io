<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Portcullis Labs &#187; training</title>
	<atom:link href="https://portcullislabs.github.io/tag/training/feed/" rel="self" type="application/rss+xml" />
	<link>https://portcullislabs.github.io</link>
	<description>Research and Development</description>
	<language>en-US</language>
		<sy:updatePeriod>hourly</sy:updatePeriod>
		<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.8.5</generator>
	<item>
		<title>Use Infrastructure as Code they said. Easier to audit they said&#8230; (part 1)</title>
		<link>https://portcullislabs.github.io/blog/use-infrastructure-as-code-they-said-easier-to-audit-they-said-part-1/</link>
		<comments>https://portcullislabs.github.io/blog/use-infrastructure-as-code-they-said-easier-to-audit-they-said-part-1/#comments</comments>
		<pubDate>Sat, 26 Jan 2019 22:06:06 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[auditing]]></category>
		<category><![CDATA[devops]]></category>
		<category><![CDATA[devsecops]]></category>
		<category><![CDATA[infradev]]></category>
		<category><![CDATA[orchestration]]></category>
		<category><![CDATA[seceng]]></category>
		<category><![CDATA[secops]]></category>
		<category><![CDATA[sre]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6839</guid>
		<description><![CDATA[<p>Whilst there are some great examples of how to assess infrastructure as code dynamically with things like the Center for Internet Security&#8216;s Docker benchmark and CoreOS&#8216;s Clair, these kinda run a little too late in the pipeline for my liking. If we want to treat infrastructure as code then surely we ought to be performing [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/use-infrastructure-as-code-they-said-easier-to-audit-they-said-part-1/">Use Infrastructure as Code they said. Easier to audit they said&#8230; (part 1)</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Whilst there are some great examples of how to assess infrastructure as code dynamically with things like the <a title="Center for Internet Security" href="https://www.cisecurity.org/">Center for Internet Security</a>&#8216;s <a title="Docker benchmark" href="https://www.cisecurity.org/benchmark/docker/">Docker benchmark</a> and <a title="CoreOS" href="https://github.com/coreos/">CoreOS</a>&#8216;s <a title="Clair" href="https://github.com/coreos/clair">Clair</a>, these kinda run a little too late in the pipeline for my liking. If we want to treat infrastructure as code then surely we ought to be performing code reviews and if we&#8217;re performing code reviews then perhaps we can perform a subset of these checks automatically pre-commit?<span id="more-6839"></span></p>
<p>Many of the current generation of infrastructure orchestration tools utilise Domain Specific Languages presented through the medium of YAML, JSON etc which allow the infradev team to specify programmatically, the architecture and nature of the infrastructure they manage. Just how secure are these language and where might we find gaps that an offensive party might seek to exploit? In practice, what I was really thinking was, if I want to review commits (automatically), then what exactly do I want my tools to look for and why? This seems like an obvious question but at that point, I hadn&#8217;t seen a huge amount of talk (or more importantly, based on the work I do, evidence) on how others were doing this to review their templates before they&#8217;d been built and deployed&#8230;.</p>
<p>The good news is that somewhere along the way, whilst I was still asking around and before I started to work on this series of posts, I discovered <a title="cfn_nag" href="https://github.com/stelligent/cfn_nag">cfn_nag</a> which looked like a great start, albeit only if you&#8217;re working on <a title="AWS" href="https://aws.amazon.com/">AWS</a>&#8216;s <a title="CloudFormation" href="https://aws.amazon.com/cloudformation/">CloudFormation</a> platform. Taking inspiration from this discovery, my next search was for a linting tool for Ansible (my preferred choice for infrastructure orchestration) and this too yielded results, namely <a title="ansible-lint" href="https://github.com/ansible/ansible-lint">ansible-lint</a>. It turns out that there is more going on than I&#8217;d originally feared but that if you want to do this kind of thing (and you should), you really want to be looking for linting tools for your preferred templating language. One observation I&#8217;ll make however is that many of these linters don&#8217;t appear to have a regular stream of updates and that they may only support a limited set of checks.</p>
<p>In the next part of my thought experiment, we’ll take a deeper dive and I&#8217;ll start to consider just how effective these linters are, looking at both the theory of static analysis and code review as it applies to secure development more generally and just as importantly, looking at the assurance these tools can give you.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/use-infrastructure-as-code-they-said-easier-to-audit-they-said-part-1/">Use Infrastructure as Code they said. Easier to audit they said&#8230; (part 1)</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/use-infrastructure-as-code-they-said-easier-to-audit-they-said-part-1/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>An offensive introduction to Active Directory on UNIX</title>
		<link>https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/</link>
		<comments>https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/#comments</comments>
		<pubDate>Thu, 06 Dec 2018 09:18:36 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[analysis]]></category>
		<category><![CDATA[auditing]]></category>
		<category><![CDATA[Black Hat Europe]]></category>
		<category><![CDATA[blue team]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[exploit]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[red team]]></category>
		<category><![CDATA[root]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[UNIX]]></category>
		<category><![CDATA[Windows]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6805</guid>
		<description><![CDATA[<p>By way of an introduction to our talk at Black Hat Europe, Security Advisory EMEAR would like to share the background on our recent research into some common Active Directory integration solutions. Just as with Windows, these solutions can be utilized to join UNIX infrastructure to enterprises&#8217; Active Directory forests. Background to Active Directory integration [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/">An offensive introduction to Active Directory on UNIX</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>By way of an introduction to <a href="https://www.blackhat.com/eu-18/briefings/schedule/index.html#where-2-worlds-collide-bringing-mimikatz-et-al-to-unix-12962" title="our talk">our talk</a> at Black Hat Europe, <a href="https://www.cisco.com/c/en/us/products/security/advisory-services.html" title="Security Advisory EMEAR">Security Advisory EMEAR</a> would like to share the background on our recent research into some common Active Directory integration solutions. Just as with Windows, these solutions can be utilized to join UNIX infrastructure to enterprises&#8217; Active Directory forests.<span id="more-6805"></span></p>
<h2>Background to Active Directory integration solutions</h2>
<p>Having seen an uptick in unique UNIX infrastructures that are integrated into customers&#8217; existing Active Directory forests, the question becomes, &#8220;Does this present any concerns that may not be well understood?&#8221; This quickly became &#8220;What if an adversary could get into a UNIX box and then breach your domain?&#8221;<br />
Within a typical Active Directory integration solution (in this case <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/5.7_release_notes/sssd" title="SSSD">SSSD</a>), the solution shares a striking similarity to what a user might see on Windows. Notably, you have:</p>
<ul>
<li>DNS &#8211; Used for name resolution</li>
<li>LDAP &#8211; Used for &#8220;one-time identification&#8221; and assertion of identity</li>
<li>Kerberos &#8211; Used for ongoing authentication</li>
<li>SSSD &#8211; Like LSASS</li>
<li>PAM &#8211; Like msgina.dll or the more modern credential providers</li>
</ul>
<p>You can see a breakdown of this process <a title="here" href="https://rhelblog.redhat.com/2015/02/04/overview-of-direct-integration-options/">here</a>. Unlike Windows, there is no Group Policy for the most part (with some exceptions), so policies for sudo et al. are typically pushed as flat files to hosts.</p>
<h2>Our research</h2>
<p>Realistically, the threat models associated with each part of the implementation should be quite familiar to anyone securing a heterogeneous Windows network. Having worked with a variety of customers, it becomes apparent that the typical UNIX administrator who does not have a strong background in Windows and Active Directory will be ill-equipped to handle this threat. While we&#8217;ve been talking about successful attacks against components such as LSASS and Kerberos for quite some time, Mimikatz dates back to at least April 2014, and dumping hashes has been around even longer. Pwdump, which dumped local Windows hashes, was published by Jeremy Allison in 1997). However, no one has really taken a concerted look at whether these attacks are possible on UNIX infrastructure, nor how a blue team might spot an adversary performing them.</p>
<p>As a result of this research, we were able to develop tactics, tools, and procedures that might further assist an attacker in breaching an enterprise, and we began documenting and developing appropriate strategies to allow blue teams to appropriately detect and respond to such incursions. The Black Hat EU slides can be found <a title="here" href="/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/">here</a> and whilst the tools we developed can be found on <a href="https://github.com/portcullislabs/linikatz" title="our GitHub repo">our GitHub repo</a>.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/">An offensive introduction to Active Directory on UNIX</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Where 2 worlds collide: Bringing Mimikatz et al to UNIX</title>
		<link>https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/</link>
		<comments>https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/#comments</comments>
		<pubDate>Thu, 06 Dec 2018 08:04:06 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Presentations]]></category>
		<category><![CDATA[analysis]]></category>
		<category><![CDATA[auditing]]></category>
		<category><![CDATA[Black Hat Europe]]></category>
		<category><![CDATA[blue team]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[exploit]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[red team]]></category>
		<category><![CDATA[root]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[UNIX]]></category>
		<category><![CDATA[Windows]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6806</guid>
		<description><![CDATA[<p>Presentation on Active Directory integration solutions for UNIX (as given at Black Hat Europe 2018). Over the past fifteen years there&#8217;s been an uptick in &#8220;interesting&#8221; UNIX infrastructures being integrated into customers&#8217; existing AD forests. Whilst the threat models enabled by this should be quite familiar to anyone securing a heterogeneous Windows network, they may [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/">Where 2 worlds collide: Bringing Mimikatz et al to UNIX</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Presentation on Active Directory integration solutions for UNIX (as given at Black Hat Europe 2018).<span id="more-6806"></span></p>
<p>Over the past fifteen years there&#8217;s been an uptick in &#8220;interesting&#8221; UNIX infrastructures being integrated into customers&#8217; existing AD forests. Whilst the threat models enabled by this should be quite familiar to anyone securing a heterogeneous Windows network, they may not be as well understood by a typical UNIX admin who does not have a strong background in Windows and AD. Over the last few months we&#8217;ve spent some time looking a number of specific Active Directory integration solutions (both open and closed source) for UNIX systems and documenting some of the tools, tactics and procedures that enable attacks on the forest to be staged from UNIX.</p>
<p>This talk describes the technical details regarding our findings. It includes Proof of Concepts (PoC) showing real-world attacks against AD joined UNIX systems. Finally, potential solutions or mitigation controls are discussed that will help to either prevent those attacks or at the very least to detect them when they occur.</p>
<p>Tools referenced in this talk include:</p>
<ul>
<li><a href="https://github.com/portcullislabs/linikatz" title="Linikatz">Linikatz</a></li>
<ul>
<li><a href="https://github.com/portcullislabs/linikatz/tree/master/red/JohnTheRipper" title="JohnTheRipper dynamic.conf rules">JohnTheRipper dynamic.conf rules</a></li>
<li><a href="https://github.com/portcullislabs/linikatz/tree/master/red/metasploit-framework" title="metasploit-framework post-exploitation modules">metasploit-framework post-exploitation modules</a></li>
<li><a href="https://github.com/portcullislabs/linikatz/tree/master/blue/audit" title="auditd policies">auditd policies</a></li>
<li><a href="https://github.com/portcullislabs/linikatz/tree/master/tools/vas/fuzzers" title="fuzzers">fuzzers</a></li>
</ul>
</ul>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-1').click();">
  <div class="icon"><a href="https://portcullislabs.github.io/download/eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX.pdf" target="_blank" title="Download Eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX"><img align="middle" src="https://portcullislabs.github.io/wp-includes/images/crystal/document.png" alt="Eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX" /></a></div>
  <div class="filetitle">
    <a href="https://portcullislabs.github.io/download/eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX.pdf" title="Download eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX.pdf" target="_blank" id="wpfb-file-link-1">eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX.pdf</a>
    
    <br />
    December 6, 2018<br />
    
  </div>
  <div class="info">
    724.9 KiB<br />
    MD5 hash: cc712c5e46b16fbff22a2566b1248a91 <br />
    <a href="#" onclick="return wpfilebase_filedetails(1);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails1" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>December 6, 2018</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/">Where 2 worlds collide: Bringing Mimikatz et al to UNIX</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>The importance of logs: You won&#8217;t see what you don&#8217;t log</title>
		<link>https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/</link>
		<comments>https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/#comments</comments>
		<pubDate>Wed, 31 Oct 2018 12:36:40 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Presentations]]></category>
		<category><![CDATA[blue team]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[red team]]></category>
		<category><![CDATA[SecureSouthWest]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6793</guid>
		<description><![CDATA[<p>Presentation on logging and auditing strategies (as given at Secure South West 11). Building on my blog post on Cisco&#8217;s security blog entitled The Importance of Logs, I put together a presentation that picks apart some of the practical aspects of building a successful logging capability focusing on the need to document &#8220;good&#8221; and curate [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/">The importance of logs: You won&#8217;t see what you don&#8217;t log</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Presentation on logging and auditing strategies (as given at Secure South West 11).<span id="more-6793"></span></p>
<p>Building on my blog post on Cisco&#8217;s security blog entitled <a href="https://blogs.cisco.com/security/the-importance-of-logs">The Importance of Logs</a>, I put together a presentation that picks apart some of the practical aspects of building a successful logging capability focusing on the need to document &#8220;good&#8221; and curate &#8220;bad&#8221;.</p>
<p>The purpose of this talk is not to help you build a SOC in 30 minutes, rather it looks at how logging can go wrong and how to plan in order to get it right. The talk includes some composite case studies which highlight some of the challenges that we&#8217;ve seen over the years (particularly when responding in customer breaches) and makes some suggestions on where interested organisations should focus their efforts next.</p>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-2').click();">
  <div class="icon"><a href="https://portcullislabs.github.io/download/SSWTIOLYWSWYDL.pdf" target="_blank" title="Download SSWTIOLYWSWYDL"><img align="middle" src="https://portcullislabs.github.io/wp-includes/images/crystal/document.png" alt="SSWTIOLYWSWYDL" /></a></div>
  <div class="filetitle">
    <a href="https://portcullislabs.github.io/download/SSWTIOLYWSWYDL.pdf" title="Download SSWTIOLYWSWYDL.pdf" target="_blank" id="wpfb-file-link-2">SSWTIOLYWSWYDL.pdf</a>
    
    <br />
    October 31, 2018<br />
    
  </div>
  <div class="info">
    463.7 KiB<br />
    MD5 hash: 390c1d8b29e74f2c15df434b4d0d9f99 <br />
    <a href="#" onclick="return wpfilebase_filedetails(2);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails2" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>October 31, 2018</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/">The importance of logs: You won&#8217;t see what you don&#8217;t log</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Grabbing firmware from my cheap STM32-based magstripe reader (using ST-Link v2)</title>
		<link>https://portcullislabs.github.io/blog/grabbing-firmware-from-my-cheap-stm32-based-magstripe-reader-using-st-link-v2/</link>
		<comments>https://portcullislabs.github.io/blog/grabbing-firmware-from-my-cheap-stm32-based-magstripe-reader-using-st-link-v2/#comments</comments>
		<pubDate>Fri, 20 Jul 2018 08:00:27 +0000</pubDate>
		<dc:creator><![CDATA[MRL]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[hardhack]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6583</guid>
		<description><![CDATA[<p>In my previous post, I worked around the fact that the card reader could only read credit cards &#8211; when I wanted to read other types of magstripes. I&#8217;d thought at the time that it would theoretically be possible to replace the firmware. In this post I don&#8217;t get as far as writing new firmware, [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/grabbing-firmware-from-my-cheap-stm32-based-magstripe-reader-using-st-link-v2/">Grabbing firmware from my cheap STM32-based magstripe reader (using ST-Link v2)</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>In my <a title="previous post" href="/blog/reading-hotel-key-cards-with-a-credit-card-magstripe-reader/">previous post</a>, I worked around the fact that the card reader could only read credit cards &#8211; when I wanted to read other types of magstripes. I&#8217;d thought at the time that it would theoretically be possible to replace the firmware. In this post I don&#8217;t get as far as writing new firmware, but I to present an easy way to download and upload firmware: The ST-Link v2 USB device (hardware) and associated ST-Link Utility (software).<span id="more-6583"></span></p>
<h2>Inspiration</h2>
<p>I&#8217;d been watching YouTube videos about microcontrollers, when I stumbled across <a title="How to Set up the ST-Link v2 Programmer Tutorial for ARM Microcontrollers" href="https://www.youtube.com/watch?v=QgC_6R1_R-o">How to Set up the ST-Link v2 Programmer Tutorial for ARM Microcontrollers</a>. I hadn&#8217;t come across this method of programming microcontrollers before. Previously, I&#8217;d only programmed my Arduino via UART.</p>
<p>I got straight on eBay and bought a programmer from a local supplier, so it would arrive quickly. The same thing is also available for about £2 from China.</p>
<div id="attachment_6608" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6584"><div class="lb-album"><a href="#image-6584"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/stlink1-300x300.png" alt="ST-Link v2 on eBay" class="size-medium wp-image-6608"><span></span></a></div>              
<a href="#imageclose-6584" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6584">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/stlink1.png" alt="image-6584">
                   </div></a><p class="wp-caption-text">ST-Link v2 on eBay</p></div>
<h2>Pinout</h2>
<p>The chip I wanted to program/read was the STM32F102C8 from my cheap magstripe reader:</p>
<div id="attachment_6601" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6585"><div class="lb-album"><a href="#image-6585"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chip-300x228.jpg" alt="Chip on card reader" class="size-medium wp-image-6601"><span></span></a></div>              
<a href="#imageclose-6585" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6585">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chip.jpg" alt="image-6585">
                   </div></a><p class="wp-caption-text">Chip on card reader</p></div>
<p>The <a title="datasheet (pdf)" href="http://www.st.com/resource/en/datasheet/stm32f102c8.pdf">datasheet (pdf)</a> showed the pinout information I needed:</p>
<div id="attachment_6602" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6586"><div class="lb-album"><a href="#image-6586"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/pinout-300x168.png" alt="Pinout from STM32 datasheet" class="size-medium wp-image-6602"><span></span></a></div>              
<a href="#imageclose-6586" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6586">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/pinout.png" alt="image-6586">
                   </div></a><p class="wp-caption-text">Pinout from STM32 datasheet</p></div>
<p>The pins I needed to locate were the Serial Wire Debug (SWD) pins. Specifically SWDIO and SWCLK:</p>
<div id="attachment_6605" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6587"><div class="lb-album"><a href="#image-6587"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/pins-300x100.png" alt="Locations of SWDIO/SWCLK pins" class="size-medium wp-image-6605"><span></span></a></div>              
<a href="#imageclose-6587" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6587">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/pins.png" alt="image-6587">
                   </div></a><p class="wp-caption-text">Locations of SWDIO/SWCLK pins</p></div>
<p>Marking up the previous diagrams, we have identified the pins we need:</p>
<div id="attachment_6603" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6588"><div class="lb-album"><a href="#image-6588"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/pinout-markup-300x168.png" alt="Location of the pins we need" class="size-medium wp-image-6603"><span></span></a></div>              
<a href="#imageclose-6588" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6588">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/pinout-markup.png" alt="image-6588">
                   </div></a><p class="wp-caption-text">Location of the pins we need</p></div>
<div id="attachment_6610" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6589"><div class="lb-album"><a href="#image-6589"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chip-Copy-Copy-300x227.jpg" alt="Pin locations marked" class="size-medium wp-image-6610"><span></span></a></div>              
<a href="#imageclose-6589" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6589">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chip-Copy-Copy.jpg" alt="image-6589">
                   </div></a><p class="wp-caption-text">Pin locations marked</p></div>
<p>In case you&#8217;re wondering, if you connect your oscilloscope to the SWDIO and SWCLK pins while the device is powered up, you don&#8217;t see any signals. But this doesn&#8217;t mean the pins are disabled &#8211; as we&#8217;ll show below.</p>
<h2>Soldering</h2>
<p>After successfully soldering some enamelled copper wire to the pins, then almost ripping the pins off accidentally, I used some hot clue as strain relief. The other end of the wire was connected to some 0.1&#8243; headers so I could use dupont cables to connect to the ST-Link.</p>
<div id="attachment_6612" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6590"><div class="lb-album"><a href="#image-6590"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/fine-300x115.jpg" alt="Connections soldered to pins" class="size-medium wp-image-6612"><span></span></a></div>              
<a href="#imageclose-6590" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6590">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/fine.jpg" alt="image-6590">
                   </div></a><p class="wp-caption-text">Connections soldered to pins</p></div>
<p>I was pretty pleased with my soldering as it was the first time I&#8217;d soldered to pins with such fine pitch. I found that by tinning the wire very slightly, then resting the wire on the pin as I gently lowered the soldering iron (no solder on the iron), I was able to avoid spreading solder onto the nearby pins.</p>
<h2>Connecting to ST-Link</h2>
<p>Using dupont connectors we need to make 3 connections between the ST-Link device and the target board: SWDIO, SWCLK and Ground. The ST-Link clearly labels the various pins:</p>
<div id="attachment_6622" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6591"><div class="lb-album"><a href="#image-6591"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/st-300x189.jpg" alt="ST-Link and magstripe reader connected" class="size-medium wp-image-6622"><span></span></a></div>              
<a href="#imageclose-6591" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6591">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/st.jpg" alt="image-6591">
                   </div></a><p class="wp-caption-text">ST-Link and magstripe reader connected</p></div>
<p>Below the required connections have been made using the Black (SWDIO), Grey (SWCLK) and White (ground) connectors &#8211; though it&#8217;s hard to see and a bit confusing because of all the unrelated wires:</p>
<div id="attachment_6623" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6592"><div class="lb-album"><a href="#image-6592"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/st3-300x213.jpg" alt="Relevant connections highlighted between ST-Link and target" class="size-medium wp-image-6623"><span></span></a></div>              
<a href="#imageclose-6592" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6592">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/st3.jpg" alt="image-6592">
                   </div></a><p class="wp-caption-text">Relevant connections highlighted between ST-Link and target</p></div>
<p>Now we just need to load up the software and connect using the button shown below:</p>
<div id="attachment_6620" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6593"><div class="lb-album"><a href="#image-6593"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/0connect-to-target-300x148.png" alt="Connect button" class="size-medium wp-image-6620"><span></span></a></div>              
<a href="#imageclose-6593" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6593">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/0connect-to-target.png" alt="image-6593">
                   </div></a><p class="wp-caption-text">Connect button</p></div>
<p>Then we can read the firmware. I tweaked the start address and length to values that seemed to get me the whole firmware. The start address can be either 0&#215;00000000 or 0&#215;8000000:</p>
<div id="attachment_6621" style="width: 283px" class="wp-caption alignnone"><a name="imageclose-6594"><div class="lb-album"><a href="#image-6594"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/1read-273x300.png" alt="Successful Firmware Read" class="size-medium wp-image-6621"><span></span></a></div>              
<a href="#imageclose-6594" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6594">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/1read.png" alt="image-6594">
                   </div></a><p class="wp-caption-text">Successful firmware read</p></div>
<p>To save to a file (always good to have a backup), use the button shown:</p>
<div id="attachment_6615" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6595"><div class="lb-album"><a href="#image-6595"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/2save-300x91.png" alt="Save Firmware To a .bin file" class="size-medium wp-image-6615"><span></span></a></div>              
<a href="#imageclose-6595" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6595">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/2save.png" alt="image-6595">
                   </div></a><p class="wp-caption-text">Save firmware to a .bin File</p></div>
<p>Once the file has been saved, it can be written back using the &#8220;Program Verify&#8221; button:</p>
<div id="attachment_6617" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6596"><div class="lb-album"><a href="#image-6596"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/4program-300x92.png" alt="Button to Program Target with a Local .bin File" class="size-medium wp-image-6617"><span></span></a></div>              
<a href="#imageclose-6596" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6596">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/4program.png" alt="image-6596">
                   </div></a><p class="wp-caption-text">Button to program target with a local .bin File</p></div>
<div id="attachment_6618" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6597"><div class="lb-album"><a href="#image-6597"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/5program2-300x205.png" alt="Programming Options" class="size-medium wp-image-6618"><span></span></a></div>              
<a href="#imageclose-6597" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6597">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/5program2.png" alt="image-6597">
                   </div></a><p class="wp-caption-text">Programming options</p></div>
<p>After writing, I reset the magstripe reader to check it still worked. It did.</p>
<p>So, with very little effort we were able to read and write firmware to the device.</p>
<h2>Conclusion</h2>
<p>YouTube videos can be educational as well as fun. Sometimes, reading the firmware can be a lot easier than you&#8217;d ever expect. Checking if pins are active using only an oscilloscope wasn&#8217;t appropriate in this instance. We actually needed to try communicating with the device.</p>
<h2>Where next?</h2>
<p>If I was minded to create something rather than to take things apart all the time, I&#8217;d probably connect the STM32 to my Arduino software and see if I could write a sketch to read the input pins that connect to the magnetic read heads (via the op amps). Then I&#8217;d figure out to do HID emulation (as the original firmware did) so I could read arbitrary magstripes rather than just payment cards.</p>
<p>I got as far as tracing out the 3 input pins using the continuity testing feature on my multimeter.</p>
<p>I was also interested to know if I could have figured out the input pins from looking at the firmware. I loaded up the firmware in Hopper &#8211; which was surprisingly easy. But haven&#8217;t yet understood it to the extent where I could figure out input pins used. Apparently the assembler code to read of each pin is pretty distinctive, so this certainly seems possible to search for &#8211; once you&#8217;ve understood the datasheet enough to know what to search for exactly. Checkout 4m30s onwards in this <a title="LiveOverflow YouTube video" href="https://www.youtube.com/watch?v=hyoPAOTrUMc">LiveOverflow YouTube video</a>.</p>
<p>It might be possible to write some nefarious firmware that seems to operate as normal, but secretly logs card numbers to the internal flash. Alternatively, maybe it just waits until midnight before it plays a load of malicious keystrokes to the host computer. Or maybe it only plays malicious keystrokes out when an attacker&#8217;s creditcard is swiped.</p>
<p>You might want to check out the <a title="stm32duino / Blue Pill" href="http://wiki.stm32duino.com/index.php?title=Blue_Pill">stm32duino / Blue Pill</a>, which uses the same family of microprocessors and the <a title="Pill Duck" href="https://github.com/satoshinm/pill_duck">Pill Duck</a> project which is essentially a <a title="USB Rubber Ducky" href="https://hakshop.com/products/usb-rubber-ducky-deluxe">USB Rubber Ducky</a> type device that uses the Blue Pill hardware. Take care when Googling for blue pills, though.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/grabbing-firmware-from-my-cheap-stm32-based-magstripe-reader-using-st-link-v2/">Grabbing firmware from my cheap STM32-based magstripe reader (using ST-Link v2)</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/grabbing-firmware-from-my-cheap-stm32-based-magstripe-reader-using-st-link-v2/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Reading hotel key cards with a credit card magstripe reader</title>
		<link>https://portcullislabs.github.io/blog/reading-hotel-key-cards-with-a-credit-card-magstripe-reader/</link>
		<comments>https://portcullislabs.github.io/blog/reading-hotel-key-cards-with-a-credit-card-magstripe-reader/#comments</comments>
		<pubDate>Wed, 04 Jul 2018 06:01:58 +0000</pubDate>
		<dc:creator><![CDATA[MRL]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[hardhack]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6481</guid>
		<description><![CDATA[<p>In this post I describe how my cheap magstripe reader wouldn&#8217;t read all magstripes, only credit/debit cards. This did nothing to help me understand what data was on my hotel key card &#8211; which is what I really wanted to know. Rather than take the obvious next step or buying a better reader, I opted [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/reading-hotel-key-cards-with-a-credit-card-magstripe-reader/">Reading hotel key cards with a credit card magstripe reader</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>In this post I describe how my cheap magstripe reader wouldn&#8217;t read all magstripes, only credit/debit cards. This did nothing to help me understand what data was on my hotel key card &#8211; which is what I really wanted to know. Rather than take the obvious next step or buying a better reader, I opted to open up the cheap magstripe reader, probed around a bit and found a way to read the raw data off the hotel magstripes. What that data means remains a mystery so there may be a part 2 at some stage.<span id="more-6481"></span></p>
<h2>About my magstripe reader</h2>
<p>I bought the following reader for £11.85 in 2017:</p>
<div id="attachment_6519" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6482"><div class="lb-album"><a href="#image-6482"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/myreader1-300x254.png" alt="Cheap reader from eBay" class="size-medium wp-image-6519"><span></span></a></div>              
<a href="#imageclose-6482" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6482">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/myreader1.png" alt="image-6482">
                   </div></a><p class="wp-caption-text">Cheap reader from eBay</p></div>
<p>It connects via USB and is detected as a keyboard. If you swipe a credit/debit card through the reader, the corresponding data from the magstripe will appear if your text editor as if it had been typed. If you don&#8217;t have a text editor open at the time, you&#8217;ll get the effect of whatever the keystrokes on the magstripe reader are!</p>
<p>It works fine under both Windows and Linux. But only for credit/debit cards. When I swiped a hotel key card through, I got no data at all.</p>
<h2>Why not just get a different reader?</h2>
<p>I could have taken a couple of different (and no doubt better) approaches to this project. Finding a better magstripe reader was one option. Googling around to better understand hotel magstripes would have no-doubt been fruitful, but potentially spoils some of problem solving. I can always google later when I&#8217;m properly stuck. <img src="https://portcullislabs.github.io/wp-includes/images/smilies/icon_smile.gif" alt=":-)" class="wp-smiley" /> </p>
<p>I since invested in an MSR605X reader/writer. I haven&#8217;t played with it much yet, but it is able to do raw reads. I&#8217;ll probably cover this reader in a future post.</p>
<h2>Plan for the cheap reader</h2>
<p>I figured that the magnetic read head in the cheap reader would almost certainly be able to read the data from from hotel cards or any other card with a magstripe. But the rest of the reader was only able to interpret payment card data. If I could probe the electrical signals in the right place within the reader, I should be able to see the 1&#8242;s and 0&#8242;s on the magstripe.</p>
<div id="attachment_6520" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6483"><div class="lb-album"><a href="#image-6483"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readhead-300x160.png" alt="Magnetic read head inside card reader" class="size-medium wp-image-6520"><span></span></a></div>              
<a href="#imageclose-6483" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6483">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readhead.png" alt="image-6483">
                   </div></a><p class="wp-caption-text">Magnetic read head inside card reader</p></div>
<p>I was a vague plan and certainly not the path of least resistance, but would ultimately work&#8230;</p>
<h2>Probing around</h2>
<p>I had two tools at my disposal to probe with (this was a home-based side project as opposed to an office-based project):</p>
<ul>
<li>A cheap handheld Oscilloscope (Sainsmart DS202)</li>
<li>A Saleae logic analyzer</li>
</ul>
<p>I quickly realized there were 7 points on the read head I could attach probes to.</p>
<div id="attachment_6521" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6484"><div class="lb-album"><a href="#image-6484"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readheadback-300x149.png" alt="Connection points on back of read head" class="size-medium wp-image-6521"><span></span></a></div>              
<a href="#imageclose-6484" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6484">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readheadback.png" alt="image-6484">
                   </div></a><p class="wp-caption-text">Connection points on back of read head</p></div>
<p>I figured if hooked the read head directly up to my scope, I&#8217;d be able to see an analogue signal when I swiped a card. Ultimately I hoped to do something with said signal to get the data I wanted.</p>
<div id="attachment_6522" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6485"><div class="lb-album"><a href="#image-6485"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readheadsoldered-300x178.png" alt="Connections for scope soldered directly to read head" class="size-medium wp-image-6522"><span></span></a></div>              
<a href="#imageclose-6485" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6485">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readheadsoldered.png" alt="image-6485">
                   </div></a><p class="wp-caption-text">Connections for scope soldered directly to read head</p></div>
<p>I tried hooking up various pairs from these 7 probe points to my scope, but didn&#8217;t find any signal at all. Maybe the signal&#8217;s too weak, or maybe (in retrospect) I did a rubbish job of identifying a suitable ground.</p>
<p>By this point I&#8217;d started googling the chip numbers. There were 2 x Op Amps and 1 x Analogue Comparator:</p>
<ul>
<li>2 x <a title="LM2902DG" href="https://www.mouser.co.uk/ProductDetail/ON-Semiconductor/LM2902DG">LM2902DG</a> (Op Amp)</li>
<li>1 x <a title="LM2901DG" href="https://www.mouser.co.uk/ProductDetail/ON-Semiconductor/LM2901DG">LM2901DG</a> (Analogue Comparator)</li>
</ul>
<div id="attachment_6523" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6486"><div class="lb-album"><a href="#image-6486"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chips1-300x105.png" alt="2 x Op Amps" class="size-medium wp-image-6523"><span></span></a></div>              
<a href="#imageclose-6486" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6486">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chips1.png" alt="image-6486">
                   </div></a><p class="wp-caption-text">2 x Op Amps</p></div>
<div id="attachment_6524" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6487"><div class="lb-album"><a href="#image-6487"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chips2-300x123.jpg" alt="Analogue Comparator (left); STM32 Microcontroller (right)" class="size-medium wp-image-6524"><span></span></a></div>              
<a href="#imageclose-6487" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6487">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chips2.jpg" alt="image-6487">
                   </div></a><p class="wp-caption-text">Analogue Comparator (left); STM32 Microcontroller (right)</p></div>
<p>These chips were responsible for amplifying the signal from the read head. So if hooked up to the output of each, I might see a signal I could use to determine the data on the magstripes. I use the datasheets to identify the output pins of each IC.</p>
<p>The output from the 2 x Op Amps was about 0.5 &#8211; 0.6v peak-to-peak. Easily viewable using my scope, but I&#8217;d be unable to feed this into my logic analyser. I&#8217;d need about 3v peak-to-peak for that. The signal was also quite scruffy looking. Not the nice square wave I&#8217;d hoped for.</p>
<p>The output from the analogue comparator was exactly what I was after. A nice 3 or 4v peak-to-peak square wave that appeared only when I swiped a card. There were 4 outputs from the comparator. One never produced a signal. This seemed reasonable for a read head that could read 3-track magstripes. Time to feed this into the logic analyser and start figuring what constituted a 0 or 1&#8230;</p>
<h2>1&#8242;s and 0&#8242;s</h2>
<p>Progress had been quite fast up to this point. This was shaping up to be an interesting project.</p>
<p>Here&#8217;s the output from the comparator viewed in the Saleae Logic software:</p>
<div id="attachment_6525" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6488"><div class="lb-album"><a href="#image-6488"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/square-300x69.png" alt="Comparator output viewed via logic analyser" class="size-medium wp-image-6525"><span></span></a></div>              
<a href="#imageclose-6488" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6488">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/square.png" alt="image-6488">
                   </div></a><p class="wp-caption-text">Comparator output viewed via logic analyser</p></div>
<p>Note that we&#8217;re only seeing 1 square wave, not 3. This is because this particular card only has data on 1 of the 3 tracks.</p>
<p>So we have a signal to analyse, but we don&#8217;t have 1&#8242;s and 0&#8242;s yet.</p>
<p><a title="Phrack37" http://phrack.org/issues/37/6.html#article">Phrack37</a> from 1992 helps us with that:</p>
<div id="attachment_6527" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6489"><div class="lb-album"><a href="#image-6489"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/10-300x147.png" alt="ASCII art explanation of how 1' class="size-medium wp-image-6527"><span></span></a></div>              
<a href="#imageclose-6489" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6489">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/10.png" alt="image-6489">
                   </div></a><p class="wp-caption-text">ASCII art explanation of how 1&#8242;s and 0&#8242;s are encoded on a magstripe</p></div>
<p>Essentially a 0 and 1 are both the same length when encoded. A 1 changed state half way through and a 0 doesn&#8217;t. Note that the 0 can be either high or low.</p>
<p>Rather than decode the 1&#8242;s and 0&#8242;s by eye, I wrote a Python script that parsed the exported data from the logic analyzer and dumped the 1&#8242;s and o&#8217;s. Here&#8217;s the format used by &#8220;Logic&#8221; (the Saleae software) when exporting to CSV:</p>
<div id="attachment_6528" style="width: 287px" class="wp-caption alignnone"><a name="imageclose-6490"><div class="lb-album"><a href="#image-6490"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/csv-277x300.png" alt="Format used in CSV export from Saleae' class="size-medium wp-image-6528"><span></span></a></div>              
<a href="#imageclose-6490" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6490">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/csv.png" alt="image-6490">
                   </div></a><p class="wp-caption-text">Format used in CSV export from Saleae&#8217;s Logic software</p></div>
<p>The Python code turned out to be a pain to write because the baud rate of the data wasn&#8217;t constant. It varies depending on how fast the card is moving past the read head. I took a few wrong turns when coding this up, but eventually found a solution that worked.</p>
<p>Here&#8217;s a scatter graph that shows that the duration of square wave pulse doesn&#8217;t have exactly 2 values as expected. Instead a wide range of values are seen. It&#8217;s still possible to tell 0&#8242;s (long pulses, green dots) from 1&#8242;s (short pulses, blue/purple dots) &#8211; see top graph. The ratio of each successive pulse to the last was a better way to tell o&#8217;s from 1&#8242;s &#8211; see bottom graph:</p>
<div id="attachment_6530" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6491"><div class="lb-album"><a href="#image-6491"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/example-graph-300x218.png" alt="Graph showing how much pulse duration (delta) takes a range of values, not just two as expected" class="size-medium wp-image-6530"><span></span></a></div>              
<a href="#imageclose-6491" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6491">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/example-graph.png" alt="image-6491">
                   </div></a><p class="wp-caption-text">Graph showing how much pulse duration (delta) takes a range of values, not just two as expected</p></div>
<h2>And finally, the bytes / characters</h2>
<p>This is where my problems started. My whole life, bits have made bytes. Specifically they&#8217;ve made 8-bit bytes. This is not the case on magstripes, it turned out.</p>
<p>As mentioned in the phrack paper, credit cards use 2 tracks, one where characters are composed of 5 bits (4 bits + 1 parity) and another where characters are composed of 7 bits (6 bits + 1 parity).</p>
<p>I spent quite a bit of time coding up a decoder for credit cards. Partly because I needed to be assured that I&#8217;d read the 1&#8242;s and o&#8217;s correctly and partly because I thought I&#8217;d need the code to see if the same character types were used in hotel cards.</p>
<p>One of the challenges in coding this up was knowing where the data started and the preamble ended. It seems that &#8220;sentinels&#8221; are used to mark the start/end of the data. These are special characters (bit patterns) that readers can look for at the start and end of a stripe&#8230; then it made sense. This is why the card reader only worked for credit cards!  The firmware is looking for the sentinels used by credit cards. It can&#8217;t decode the hotel cards because it&#8217;s not obvious where the data starts or ends; or what constitutes a character. Also, perhaps lack a valid <a title="Longitudinal Redundancy Check (LRC)" href="https://en.wikipedia.org/wiki/Longitudinal_redundancy_check">Longitudinal Redundancy Check (LRC)</a>.</p>
<h2>Identifying characters on hotel magstripes</h2>
<p>I ran my credit-card code over the hotel mag stripes to see if there was odd parity with all the 5 bit chunks or all the 7 bit chunks. No, unfortunately not. Another reason the cheap magstripe reader probably failed.</p>
<p>Then I ran some frequency analysis on the 1&#8242;s and 0&#8242;s. Maybe a lot of the 5-bit chunks are all the same value?  Or the 7-bit chunks?  I&#8217;d see something similar on the credit card magstripe. There were 20 spaces on the 7-bit magstripe. So, using frequency analysis, I should have been able to guess 7-bit characters were being used.</p>
<p>By splitting some of the hotels magstripe data into 8-bit chunks, we notice that the same string of 1&#8242;s and 0&#8242;s occurs many more times than you&#8217;d expect. So my best guess is that 8-bit characters are used.</p>
<p>Below is some example output from my Python script. Not that it outputs:</p>
<ul>
<li>Raw bits</li>
<li>Strings (with hex dumps) that would be right if 5-bit, 6-bit, 7-bit or 8-bit characters were used. Though &#8220;correctness&#8221; depends on parity, bit order and what character set the bit values map to. Plenty of room for error and improvement here</li>
<li>Checks for odd/even parity within characters</li>
<li>Frequency analysis looking for common characters &#8211; for varying character lengths</li>
</ul>
<pre class="brush: bash; gutter: false; title: ; notranslate">
[+] Parsing file export.csv
 [-] Flips in channel 0: 3
 [-] Flips in channel 1: 1652
 [-] Flips in channel 2: 3
[+] Analysing swipes
 [-] Channel 0:
 [-] Channel 1:
 [-] Swipe 0: 693 bits
 [-] Swipe 1: 701 bits
 [-] Channel 2:
[+] Creating Plots
 [-] creating plots with dimensions (1637, 1637), (1637, 1637)
 [-] saving plot to file: export.csv-plot-channel-1.png
----------------------- CHANNEL 1 SWIPE 0 -----------------------
[+] Length (bits) = 266 (%5 = 1, %6 = 2, %7 = 0, % 8= 2)
[+] Data: 10100110001001100010011000100110001001100010011000100110001001100010011000100110001001100101011011100110101001001101100110100110001001100111110110111100111101100010000000100110011001101100001010010101001001001110110100000111001101011101100001100101101000101010011001
[+] Strings:
 [-] 5 bit: 5398621&lt;4398621&lt;43:&gt;62&lt;3539&lt;;&gt;&lt;=409&lt;615549=1&gt;6&gt;36=1:6
 [-] length: 53
 [-] hex: 
 35 33 39 38 36 32 31 3c 34 33 39 38 36 32 31 3c 5398621&lt;4398621&lt;
 34 33 3a 3e 36 32 3c 33 35 33 39 3c 3b 3e 3c 3d 43:&gt;62&lt;3539&lt;;&gt;&lt;=
 34 30 39 3c 36 31 35 35 34 39 3d 31 3e 36 3e 33 409&lt;615549=1&gt;6&gt;3
 36 3d 31 3a 36 6=1:6
[-] 6 bit: E(1C&amp;amp;,9RD(1CFM92;+1S;G;&quot;D,-**DMPLW8M4,
 [-] length: 38
 [-] hex: 
 45 28 31 43 26 2c 39 52 44 28 31 43 46 4d 39 32 E(1C&amp;amp;,9RD(1CFM92
 3b 2b 31 53 3b 47 3b 22 44 2c 2d 2a 2a 44 4d 50 ;+1S;G;&quot;D,-**DMP
 4c 57 38 4d 34 2c LW8M4,
[-] 7 bit: %..#...2$..#&amp;amp;-.....3.'..$....$-0,7.-.
 [-] length: 37
 [-] hex: 
 25 08 11 23 06 0c 19 32 24 08 11 23 26 2d 19 12 %..#...2$..#&amp;amp;-..
 1b 0b 11 33 1b 27 1b 02 24 0c 0d 0a 0a 24 2d 30 ...3.'..$....$-0
 2c 37 18 2d 14 ,7.-.
[-] 8 bit: .&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;V....&amp;amp;}.. &amp;amp;f..$..5.e..@
 [-] length: 34
 [-] hex: 
 a6 26 26 26 26 26 26 26 26 26 26 56 e6 a4 d9 a6 .&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;V....
 26 7d bc f6 20 26 66 c2 95 24 ed 07 35 d8 65 a2 &amp;amp;}.. &amp;amp;f..$..5.e.
 a6 40 .@
[+] Parity for 5 bit chars: odd: False, even: False)
[+] Parity for 6 bit chars: odd: False, even: False)
[+] Parity for 7 bit chars: odd: False, even: False)
[+] Parity for 8 bit chars: odd: False, even: False)
[+] Frequency analysis for potential char lengths:
 [-] 5 bits:
 10011: 5
 11000: 4
 01100: 4
 00110: 4
 00100: 4
 [-] 6 bits:
 100110: 5
 100010: 5
 011000: 5
 011001: 4
 001001: 4
 [-] 7 bits:
 1000100: 3
 0010011: 3
 1101100: 2
 1100010: 2
 1011010: 2
 [-] 8 bits:
 00100110: 12 &lt; common 8-bit patter implies 8-bit chars?
 10100110: 3
...snip...
</pre>
<p>The above data is from an actual hotel card (though the hotel as since switched to using RFID locks).</p>
<p>I also started to look at XORing, rotating of characters (rot13 style), bit order and offsetting the whole stream of bits (in case I started at the wrong place when  chunk the character up). All to no avail as yet.</p>
<p>That&#8217;s as far as I got. I&#8217;ll be sure to post again if I ever decode any of the data on the card. I was hoping to see my room number and checkout date in cleartext. But equally an opaque encrypted string wouldn&#8217;t surprise me either &#8211; which could be what I&#8217;m seeing on at least some of the cards.</p>
<h2>Conclusion</h2>
<p>Doing things the cheap and time-consuming way can be fun &#8211; and a good opportunity to write code, learn about <a title="matplotlib" href="https://matplotlib.org/">matplotlib</a> and dust off the logic analyser.</p>
<h2>Further reading/viewing</h2>
<p>If you want to know more about magstripes (before they become completely obsolete), take a look at:</p>
<ul>
<li><a title="Samy Kamkar's magspoof tool" href="https://samy.pl/magspoof/">Samy Kamkar&#8217;s magspoof tool</a> (<a title="video link" href="https://www.youtube.com/watch?v=UHSFf0Lz1qc">video link</a>) &#8211; could be useful if you need your PC to transmit bad data in through a magnetic read head.</li>
<li><a title="DEF CON 24 - Weston Hecker - Hacking Hotel Keys and Point of Sale Systems" href="https://www.youtube.com/watch?v=mV_0k9Fh590">DEF CON 24 &#8211; Weston Hecker &#8211; Hacking Hotel Keys and Point of Sale Systems</a></li>
</ul>
<p>I was pretty inspired by these projects.In this post I describe how my cheap magstripe reader wouldn&#8217;t read all magstripes, only credit/debit cards. This did nothing to help me understand what data was on my hotel key card &#8211; which is what I really wanted to know. Rather than take the obvious next step or buying a better reader, I opted to open up the cheap magstripe reader, probed around a bit and found a way to read the raw data off the hotel magstripes. What that data means remains a mystery so there may be a part 2 at some stage.<!--more--></p>
<h2>About my magstripe reader</h2>
<p>I bought the following reader for £11.85 in 2017:</p>
<div id="attachment_6519" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6482"><div class="lb-album"><a href="#image-6482"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/myreader1-300x254.png" alt="Cheap reader from eBay" class="size-medium wp-image-6519"><span></span></a></div>              
<a href="#imageclose-6482" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6482">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/myreader1.png" alt="image-6482">
                   </div></a><p class="wp-caption-text">Cheap reader from eBay</p></div>
<p>It connects via USB and is detected as a keyboard. If you swipe a credit/debit card through the reader, the corresponding data from the magstripe will appear if your text editor as if it had been typed. If you don&#8217;t have a text editor open at the time, you&#8217;ll get the effect of whatever the keystrokes on the magstripe reader are!</p>
<p>It works fine under both Windows and Linux. But only for credit/debit cards. When I swiped a hotel key card through, I got no data at all.</p>
<h2>Why not just get a different reader?</h2>
<p>I could have taken a couple of different (and no doubt better) approaches to this project. Finding a better magstripe reader was one option. Googling around to better understand hotel magstripes would have no-doubt been fruitful, but potentially spoils some of problem solving. I can always google later when I&#8217;m properly stuck. <img src="https://portcullislabs.github.io/wp-includes/images/smilies/icon_smile.gif" alt=":-)" class="wp-smiley" /> </p>
<p>I since invested in an MSR605X reader/writer. I haven&#8217;t played with it much yet, but it is able to do raw reads. I&#8217;ll probably cover this reader in a future post.</p>
<h2>Plan for the cheap reader</h2>
<p>I figured that the magnetic read head in the cheap reader would almost certainly be able to read the data from from hotel cards or any other card with a magstripe. But the rest of the reader was only able to interpret payment card data. If I could probe the electrical signals in the right place within the reader, I should be able to see the 1&#8242;s and 0&#8242;s on the magstripe.</p>
<div id="attachment_6520" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6483"><div class="lb-album"><a href="#image-6483"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readhead-300x160.png" alt="Magnetic read head inside card reader" class="size-medium wp-image-6520"><span></span></a></div>              
<a href="#imageclose-6483" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6483">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readhead.png" alt="image-6483">
                   </div></a><p class="wp-caption-text">Magnetic read head inside card reader</p></div>
<p>I was a vague plan and certainly not the path of least resistance, but would ultimately work&#8230;</p>
<h2>Probing around</h2>
<p>I had two tools at my disposal to probe with (this was a home-based side project as opposed to an office-based project):</p>
<ul>
<li>A cheap handheld Oscilloscope (Sainsmart DS202)</li>
<li>A Saleae logic analyzer</li>
</ul>
<p>I quickly realized there were 7 points on the read head I could attach probes to.</p>
<div id="attachment_6521" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6484"><div class="lb-album"><a href="#image-6484"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readheadback-300x149.png" alt="Connection points on back of read head" class="size-medium wp-image-6521"><span></span></a></div>              
<a href="#imageclose-6484" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6484">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readheadback.png" alt="image-6484">
                   </div></a><p class="wp-caption-text">Connection points on back of read head</p></div>
<p>I figured if hooked the read head directly up to my scope, I&#8217;d be able to see an analogue signal when I swiped a card. Ultimately I hoped to do something with said signal to get the data I wanted.</p>
<div id="attachment_6522" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6485"><div class="lb-album"><a href="#image-6485"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readheadsoldered-300x178.png" alt="Connections for scope soldered directly to read head" class="size-medium wp-image-6522"><span></span></a></div>              
<a href="#imageclose-6485" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6485">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/readheadsoldered.png" alt="image-6485">
                   </div></a><p class="wp-caption-text">Connections for scope soldered directly to read head</p></div>
<p>I tried hooking up various pairs from these 7 probe points to my scope, but didn&#8217;t find any signal at all. Maybe the signal&#8217;s too weak, or maybe (in retrospect) I did a rubbish job of identifying a suitable ground.</p>
<p>By this point I&#8217;d started googling the chip numbers. There were 2 x Op Amps and 1 x Analogue Comparator:</p>
<ul>
<li>2 x <a title="LM2902DG" href="https://www.mouser.co.uk/ProductDetail/ON-Semiconductor/LM2902DG">LM2902DG</a> (Op Amp)</li>
<li>1 x <a title="LM2901DG" href="https://www.mouser.co.uk/ProductDetail/ON-Semiconductor/LM2901DG">LM2901DG</a> (Analogue Comparator)</li>
</ul>
<div id="attachment_6523" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6486"><div class="lb-album"><a href="#image-6486"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chips1-300x105.png" alt="2 x Op Amps" class="size-medium wp-image-6523"><span></span></a></div>              
<a href="#imageclose-6486" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6486">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chips1.png" alt="image-6486">
                   </div></a><p class="wp-caption-text">2 x Op Amps</p></div>
<div id="attachment_6524" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6487"><div class="lb-album"><a href="#image-6487"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chips2-300x123.jpg" alt="Analogue Comparator (left); STM32 Microcontroller (right)" class="size-medium wp-image-6524"><span></span></a></div>              
<a href="#imageclose-6487" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6487">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/chips2.jpg" alt="image-6487">
                   </div></a><p class="wp-caption-text">Analogue Comparator (left); STM32 Microcontroller (right)</p></div>
<p>These chips were responsible for amplifying the signal from the read head. So if hooked up to the output of each, I might see a signal I could use to determine the data on the magstripes. I use the datasheets to identify the output pins of each IC.</p>
<p>The output from the 2 x Op Amps was about 0.5 &#8211; 0.6v peak-to-peak. Easily viewable using my scope, but I&#8217;d be unable to feed this into my logic analyser. I&#8217;d need about 3v peak-to-peak for that. The signal was also quite scruffy looking. Not the nice square wave I&#8217;d hoped for.</p>
<p>The output from the analogue comparator was exactly what I was after. A nice 3 or 4v peak-to-peak square wave that appeared only when I swiped a card. There were 4 outputs from the comparator. One never produced a signal. This seemed reasonable for a read head that could read 3-track magstripes. Time to feed this into the logic analyser and start figuring what constituted a 0 or 1&#8230;</p>
<h2>1&#8242;s and 0&#8242;s</h2>
<p>Progress had been quite fast up to this point. This was shaping up to be an interesting project.</p>
<p>Here&#8217;s the output from the comparator viewed in the Saleae Logic software:</p>
<div id="attachment_6525" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6488"><div class="lb-album"><a href="#image-6488"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/square-300x69.png" alt="Comparator output viewed via logic analyser" class="size-medium wp-image-6525"><span></span></a></div>              
<a href="#imageclose-6488" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6488">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/square.png" alt="image-6488">
                   </div></a><p class="wp-caption-text">Comparator output viewed via logic analyser</p></div>
<p>Note that we&#8217;re only seeing 1 square wave, not 3. This is because this particular card only has data on 1 of the 3 tracks.</p>
<p>So we have a signal to analyse, but we don&#8217;t have 1&#8242;s and 0&#8242;s yet.</p>
<p><a title="Phrack37" http://phrack.org/issues/37/6.html#article">Phrack37</a> from 1992 helps us with that:</p>
<div id="attachment_6527" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6489"><div class="lb-album"><a href="#image-6489"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/10-300x147.png" alt="ASCII art explanation of how 1' class="size-medium wp-image-6527"><span></span></a></div>              
<a href="#imageclose-6489" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6489">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/10.png" alt="image-6489">
                   </div></a><p class="wp-caption-text">ASCII art explanation of how 1&#8242;s and 0&#8242;s are encoded on a magstripe</p></div>
<p>Essentially a 0 and 1 are both the same length when encoded. A 1 changed state half way through and a 0 doesn&#8217;t. Note that the 0 can be either high or low.</p>
<p>Rather than decode the 1&#8242;s and 0&#8242;s by eye, I wrote a Python script that parsed the exported data from the logic analyzer and dumped the 1&#8242;s and o&#8217;s. Here&#8217;s the format used by &#8220;Logic&#8221; (the Saleae software) when exporting to CSV:</p>
<div id="attachment_6528" style="width: 287px" class="wp-caption alignnone"><a name="imageclose-6490"><div class="lb-album"><a href="#image-6490"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/csv-277x300.png" alt="Format used in CSV export from Saleae' class="size-medium wp-image-6528"><span></span></a></div>              
<a href="#imageclose-6490" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6490">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/csv.png" alt="image-6490">
                   </div></a><p class="wp-caption-text">Format used in CSV export from Saleae&#8217;s Logic software</p></div>
<p>The Python code turned out to be a pain to write because the baud rate of the data wasn&#8217;t constant. It varies depending on how fast the card is moving past the read head. I took a few wrong turns when coding this up, but eventually found a solution that worked.</p>
<p>Here&#8217;s a scatter graph that shows that the duration of square wave pulse doesn&#8217;t have exactly 2 values as expected. Instead a wide range of values are seen. It&#8217;s still possible to tell 0&#8242;s (long pulses, green dots) from 1&#8242;s (short pulses, blue/purple dots) &#8211; see top graph. The ratio of each successive pulse to the last was a better way to tell o&#8217;s from 1&#8242;s &#8211; see bottom graph:</p>
<div id="attachment_6530" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6491"><div class="lb-album"><a href="#image-6491"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/example-graph-300x218.png" alt="Graph showing how much pulse duration (delta) takes a range of values, not just two as expected" class="size-medium wp-image-6530"><span></span></a></div>              
<a href="#imageclose-6491" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6491">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/04/example-graph.png" alt="image-6491">
                   </div></a><p class="wp-caption-text">Graph showing how much pulse duration (delta) takes a range of values, not just two as expected</p></div>
<h2>And finally, the bytes / characters</h2>
<p>This is where my problems started. My whole life, bits have made bytes. Specifically they&#8217;ve made 8-bit bytes. This is not the case on magstripes, it turned out.</p>
<p>As mentioned in the phrack paper, credit cards use 2 tracks, one where characters are composed of 5 bits (4 bits + 1 parity) and another where characters are composed of 7 bits (6 bits + 1 parity).</p>
<p>I spent quite a bit of time coding up a decoder for credit cards. Partly because I needed to be assured that I&#8217;d read the 1&#8242;s and o&#8217;s correctly and partly because I thought I&#8217;d need the code to see if the same character types were used in hotel cards.</p>
<p>One of the challenges in coding this up was knowing where the data started and the preamble ended. It seems that &#8220;sentinels&#8221; are used to mark the start/end of the data. These are special characters (bit patterns) that readers can look for at the start and end of a stripe&#8230; then it made sense. This is why the card reader only worked for credit cards!  The firmware is looking for the sentinels used by credit cards. It can&#8217;t decode the hotel cards because it&#8217;s not obvious where the data starts or ends; or what constitutes a character. Also, perhaps lack a valid <a title="Longitudinal Redundancy Check (LRC)" href="https://en.wikipedia.org/wiki/Longitudinal_redundancy_check">Longitudinal Redundancy Check (LRC)</a>.</p>
<h2>Identifying characters on hotel magstripes</h2>
<p>I ran my credit-card code over the hotel mag stripes to see if there was odd parity with all the 5 bit chunks or all the 7 bit chunks. No, unfortunately not. Another reason the cheap magstripe reader probably failed.</p>
<p>Then I ran some frequency analysis on the 1&#8242;s and 0&#8242;s. Maybe a lot of the 5-bit chunks are all the same value?  Or the 7-bit chunks?  I&#8217;d see something similar on the credit card magstripe. There were 20 spaces on the 7-bit magstripe. So, using frequency analysis, I should have been able to guess 7-bit characters were being used.</p>
<p>By splitting some of the hotels magstripe data into 8-bit chunks, we notice that the same string of 1&#8242;s and 0&#8242;s occurs many more times than you&#8217;d expect. So my best guess is that 8-bit characters are used.</p>
<p>Below is some example output from my Python script. Not that it outputs:</p>
<ul>
<li>Raw bits</li>
<li>Strings (with hex dumps) that would be right if 5-bit, 6-bit, 7-bit or 8-bit characters were used. Though &#8220;correctness&#8221; depends on parity, bit order and what character set the bit values map to. Plenty of room for error and improvement here</li>
<li>Checks for odd/even parity within characters</li>
<li>Frequency analysis looking for common characters &#8211; for varying character lengths</li>
</ul>
<pre class="brush: bash; gutter: false; title: ; notranslate">
[+] Parsing file export.csv
 [-] Flips in channel 0: 3
 [-] Flips in channel 1: 1652
 [-] Flips in channel 2: 3
[+] Analysing swipes
 [-] Channel 0:
 [-] Channel 1:
 [-] Swipe 0: 693 bits
 [-] Swipe 1: 701 bits
 [-] Channel 2:
[+] Creating Plots
 [-] creating plots with dimensions (1637, 1637), (1637, 1637)
 [-] saving plot to file: export.csv-plot-channel-1.png
----------------------- CHANNEL 1 SWIPE 0 -----------------------
[+] Length (bits) = 266 (%5 = 1, %6 = 2, %7 = 0, % 8= 2)
[+] Data: 10100110001001100010011000100110001001100010011000100110001001100010011000100110001001100101011011100110101001001101100110100110001001100111110110111100111101100010000000100110011001101100001010010101001001001110110100000111001101011101100001100101101000101010011001
[+] Strings:
 [-] 5 bit: 5398621&lt;4398621&lt;43:&gt;62&lt;3539&lt;;&gt;&lt;=409&lt;615549=1&gt;6&gt;36=1:6
 [-] length: 53
 [-] hex: 
 35 33 39 38 36 32 31 3c 34 33 39 38 36 32 31 3c 5398621&lt;4398621&lt;
 34 33 3a 3e 36 32 3c 33 35 33 39 3c 3b 3e 3c 3d 43:&gt;62&lt;3539&lt;;&gt;&lt;=
 34 30 39 3c 36 31 35 35 34 39 3d 31 3e 36 3e 33 409&lt;615549=1&gt;6&gt;3
 36 3d 31 3a 36 6=1:6
[-] 6 bit: E(1C&amp;amp;,9RD(1CFM92;+1S;G;&quot;D,-**DMPLW8M4,
 [-] length: 38
 [-] hex: 
 45 28 31 43 26 2c 39 52 44 28 31 43 46 4d 39 32 E(1C&amp;amp;,9RD(1CFM92
 3b 2b 31 53 3b 47 3b 22 44 2c 2d 2a 2a 44 4d 50 ;+1S;G;&quot;D,-**DMP
 4c 57 38 4d 34 2c LW8M4,
[-] 7 bit: %..#...2$..#&amp;amp;-.....3.'..$....$-0,7.-.
 [-] length: 37
 [-] hex: 
 25 08 11 23 06 0c 19 32 24 08 11 23 26 2d 19 12 %..#...2$..#&amp;amp;-..
 1b 0b 11 33 1b 27 1b 02 24 0c 0d 0a 0a 24 2d 30 ...3.'..$....$-0
 2c 37 18 2d 14 ,7.-.
[-] 8 bit: .&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;V....&amp;amp;}.. &amp;amp;f..$..5.e..@
 [-] length: 34
 [-] hex: 
 a6 26 26 26 26 26 26 26 26 26 26 56 e6 a4 d9 a6 .&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;&amp;amp;V....
 26 7d bc f6 20 26 66 c2 95 24 ed 07 35 d8 65 a2 &amp;amp;}.. &amp;amp;f..$..5.e.
 a6 40 .@
[+] Parity for 5 bit chars: odd: False, even: False)
[+] Parity for 6 bit chars: odd: False, even: False)
[+] Parity for 7 bit chars: odd: False, even: False)
[+] Parity for 8 bit chars: odd: False, even: False)
[+] Frequency analysis for potential char lengths:
 [-] 5 bits:
 10011: 5
 11000: 4
 01100: 4
 00110: 4
 00100: 4
 [-] 6 bits:
 100110: 5
 100010: 5
 011000: 5
 011001: 4
 001001: 4
 [-] 7 bits:
 1000100: 3
 0010011: 3
 1101100: 2
 1100010: 2
 1011010: 2
 [-] 8 bits:
 00100110: 12 &lt; common 8-bit patter implies 8-bit chars?
 10100110: 3
...snip...
</pre>
<p>The above data is from an actual hotel card (though the hotel as since switched to using RFID locks).</p>
<p>I also started to look at XORing, rotating of characters (rot13 style), bit order and offsetting the whole stream of bits (in case I started at the wrong place when  chunk the character up). All to no avail as yet.</p>
<p>That&#8217;s as far as I got. I&#8217;ll be sure to post again if I ever decode any of the data on the card. I was hoping to see my room number and checkout date in cleartext. But equally an opaque encrypted string wouldn&#8217;t surprise me either &#8211; which could be what I&#8217;m seeing on at least some of the cards.</p>
<h2>Conclusion</h2>
<p>Doing things the cheap and time-consuming way can be fun &#8211; and a good opportunity to write code, learn about <a title="matplotlib" href="https://matplotlib.org/">matplotlib</a> and dust off the logic analyser.</p>
<h2>Further reading/viewing</h2>
<p>If you want to know more about magstripes (before they become completely obsolete), take a look at:</p>
<ul>
<li><a title="Samy Kamkar's magspoof tool" href="https://samy.pl/magspoof/">Samy Kamkar&#8217;s magspoof tool</a> (<a title="video link" href="https://www.youtube.com/watch?v=UHSFf0Lz1qc">video link</a>) &#8211; could be useful if you need your PC to transmit bad data in through a magnetic read head.</li>
<li><a title="DEF CON 24 - Weston Hecker - Hacking Hotel Keys and Point of Sale Systems" href="https://www.youtube.com/watch?v=mV_0k9Fh590">DEF CON 24 &#8211; Weston Hecker &#8211; Hacking Hotel Keys and Point of Sale Systems</a></li>
</ul>
<p>I was pretty inspired by these projects.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/reading-hotel-key-cards-with-a-credit-card-magstripe-reader/">Reading hotel key cards with a credit card magstripe reader</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/reading-hotel-key-cards-with-a-credit-card-magstripe-reader/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Adventures in RF: Using Inspectrum to analyse FSK and ASK/OOK signals</title>
		<link>https://portcullislabs.github.io/blog/adventures-in-rf-using-inspectrum-to-analyse-fsk-and-askook-signals/</link>
		<comments>https://portcullislabs.github.io/blog/adventures-in-rf-using-inspectrum-to-analyse-fsk-and-askook-signals/#comments</comments>
		<pubDate>Fri, 06 Apr 2018 12:42:48 +0000</pubDate>
		<dc:creator><![CDATA[MRL]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[hardhack]]></category>
		<category><![CDATA[rf]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6292</guid>
		<description><![CDATA[<p>In this post we&#8217;ll take a brief look at inspectrum, a graphical tool for analysing signals captured via software defined radio (SDR) receivers &#8211; like the RTL-SDR or HackRF One. We&#8217;ll run through two examples of viewing digital signals. The first uses frequency shift keying (FSK). The second uses amplitude shift keying on-off keying (ASK/OOK). These [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/adventures-in-rf-using-inspectrum-to-analyse-fsk-and-askook-signals/">Adventures in RF: Using Inspectrum to analyse FSK and ASK/OOK signals</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>In this post we&#8217;ll take a brief look at <a title="inspectrum" href="https://github.com/miek/inspectrum">inspectrum</a>, a graphical tool for analysing signals captured via software defined radio (SDR) receivers &#8211; like the <a title="RTL-SDR" href="https://www.rtl-sdr.com/about-rtl-sdr/">RTL-SDR</a> or <a title="HackRF One" href="https://greatscottgadgets.com/hackrf/">HackRF One</a>.<span id="more-6292"></span></p>
<p>We&#8217;ll run through two examples of viewing digital signals. The first uses <a title="frequency shift keying (FSK)" href="https://en.wikipedia.org/wiki/Frequency-shift_keying">frequency shift keying (FSK)</a>. The second uses <a title="amplitude shift keying" href="https://en.wikipedia.org/wiki/Amplitude-shift_keying">amplitude shift keying</a> <a title="on-off keying" href="https://en.wikipedia.org/wiki/On-off_keying">on-off keying</a> (ASK/OOK). These are two very common types of <a title="modulation" href="https://en.wikipedia.org/wiki/Modulation">modulation</a>.</p>
<p>I&#8217;d previously used <a title="baudline" href="http://www.baudline.com/index.html">baudline</a> for this task, which people might want to check out. But I switched to inspectrum recently. I prefer it because its simplicity and ease of use. Also, inspecrum is actively maintained, whereas baudline doesn&#8217;t seem to be.</p>
<h2>Installation</h2>
<p>If you&#8217;re on a recent Debian-based OS, you can probably:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
apt-get install inspectrum
</pre>
<p>Alternatively, installing the github version isn&#8217;t a bad option &#8211; especially if you find your lacking a couple of features. The <a title="instructions" href="https://github.com/miek/inspectrum/wiki/Build">instructions</a> are pretty good. If you find that libliquid isn&#8217;t available for your OS, you can <a title="build it" href="https://github.com/jgaeddert/liquid-dsp">build it</a> pretty easily.</p>
<h2>Example 1: FSK signal</h2>
<p>The signal for this demo is one captured from a car keyfob at 2 million samples per second. If you want to play along, plug in your RTL-SDR, HackRF One and capture a signal (e.g. using <a title="gqrx" href="http://gqrx.dk/">gqrx</a> or <a title="hackrf_transfer" href="https://github.com/mossmann/hackrf/blob/master/host/hackrf-tools/src/hackrf_transfer.c">hackrf_transfer</a>).</p>
<p>By default inspectrum assumes 32-bit complex floating point samples, which what gqrx gives us. If you used hackrf_transfer, you&#8217;ll have signed 8-bit integers, so use the file extension .cs8 &#8211; inspectrum can read that format too.</p>
<p>If you load your sample in inspectrum and set the sample rate, you&#8217;ll see something like this:</p>
<div id="attachment_6372" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6293"><div class="lb-album"><a href="#image-6293"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_135218-300x194.png" alt="Signal viewed in Inspectrum" class="size-medium wp-image-6372"><span></span></a></div>              
<a href="#imageclose-6293" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6293">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_135218.png" alt="image-6293">
                   </div></a><p class="wp-caption-text">Signal viewed in Inspectrum</p></div>
<p>We see 7 bursts of signal across 3 different frequencies.</p>
<p>Note that setting the sample rate isn&#8217;t vital. If you don&#8217;t, it just means the scale on the time axis will be wrong &#8211; not something you&#8217;ll always care about.</p>
<p>Next we&#8217;ll use the zoom slider to take a closer look at part of the signal. Hopefully we can see the 1&#8242;s and 0&#8242;s.</p>
<div id="attachment_6373" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6294"><div class="lb-album"><a href="#image-6294"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1355141-300x157.png" alt="Zoom slider usage" class="size-medium wp-image-6373"><span></span></a></div>              
<a href="#imageclose-6294" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6294">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1355141.png" alt="image-6294">
                   </div></a><p class="wp-caption-text">Zoom slider usage</p></div>
<p>Hmm. We&#8217;re hoping to see something that looks a bit like a square wave, showing the 1&#8242;s and 0&#8242;s. Which we clearly can&#8217;t see yet. Let&#8217;s tweak a few more controls.</p>
<p>Increase the &#8216;Power min&#8217; slider until the background noise becomes pure black:</p>
<div id="attachment_6374" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6295"><div class="lb-album"><a href="#image-6295"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1356051-300x145.png" alt="Decreasing Power Min slider to remove noise" class="size-medium wp-image-6374"><span></span></a></div>              
<a href="#imageclose-6295" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6295">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1356051.png" alt="image-6295">
                   </div></a><p class="wp-caption-text">Decreasing Power Min slider to remove noise</p></div>
<p>Decrease the &#8216;Power max&#8217; slider until the strongest part of the signal is shown in red.</p>
<div id="attachment_6362" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6296"><div class="lb-album"><a href="#image-6296"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1356351-300x174.png" alt="Increasing Power max slider to turn signal red" class="size-medium wp-image-6362"><span></span></a></div>              
<a href="#imageclose-6296" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6296">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1356351.png" alt="image-6296">
                   </div></a><p class="wp-caption-text">Increasing Power max slider to turn signal red</p></div>
<p>This is useful because we&#8217;ve ignored the noise and shown the signal of interest in red. But it&#8217;s still not the square wave we wanted to see.</p>
<p>The reason for this is that our FFT is showing us really good resolution in the frequncy domain (vertical axis), but really poor (fuzzy) resolution in the time domain (horizontal axis). When working with FFT plots is important to remember that you always sacrifice fidelity in one domain to improve the other. We&#8217;ll move the FFT slider to the left. This will squish our plot along the frequency axis, but stretch it along the time axis.</p>
<div id="attachment_6363" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6297"><div class="lb-album"><a href="#image-6297"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1357521-300x148.png" alt="Using FFT slider to improve resolution in time domain" class="size-medium wp-image-6363"><span></span></a></div>              
<a href="#imageclose-6297" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6297">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1357521.png" alt="image-6297">
                   </div></a><p class="wp-caption-text">Using FFT slider to improve resolution in time domain</p></div>
<p>That&#8217;s better. We can see the square wave we&#8217;d expect for an FSK signal now. It&#8217;s still a bit fuzzy, but this looks good enough to read 1&#8242;s and 0&#8242;s off. We can tweak the power settings to make things clearer:</p>
<div id="attachment_6364" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6298"><div class="lb-album"><a href="#image-6298"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1359001-300x156.png" alt="Tweak power settings to improve clarity" class="size-medium wp-image-6364"><span></span></a></div>              
<a href="#imageclose-6298" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6298">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1359001.png" alt="image-6298">
                   </div></a><p class="wp-caption-text">Tweak power settings to improve clarity</p></div>
<p>If we tick Enable cursors we can measure the duration of pulses.</p>
<div id="attachment_6365" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6299"><div class="lb-album"><a href="#image-6299"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1401121-300x177.png" alt="Using cursors" class="size-medium wp-image-6365"><span></span></a></div>              
<a href="#imageclose-6299" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6299">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1401121.png" alt="image-6299">
                   </div></a><p class="wp-caption-text">Using cursors</p></div>
<p>If we scroll around a bit, some of signal looks weak.</p>
<div id="attachment_6366" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6300"><div class="lb-album"><a href="#image-6300"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1401241-300x168.png" alt="Identifying weak parts of signal" class="size-medium wp-image-6366"><span></span></a></div>              
<a href="#imageclose-6300" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6300">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1401241.png" alt="image-6300">
                   </div></a><p class="wp-caption-text">Identifying weak parts of signal</p></div>
<p>Maybe we could still infer the square wave form, but lets see what we can do by tweaking the Power sliders again:</p>
<div id="attachment_6367" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6301"><div class="lb-album"><a href="#image-6301"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1402011-300x140.png" alt="Tweaking power sliders" class="size-medium wp-image-6367"><span></span></a></div>              
<a href="#imageclose-6301" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6301">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1402011.png" alt="image-6301">
                   </div></a><p class="wp-caption-text">Tweaking power sliders</p></div>
<p>Better, but still not a good representation. How about decreasing the FFT slider again?  This will give us better accuracy in the time domain. But will squish the 1 and 0 lines closer together.</p>
<div id="attachment_6368" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6302"><div class="lb-album"><a href="#image-6302"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1403371-300x109.png" alt="Decreasing FFT slider" class="size-medium wp-image-6368"><span></span></a></div>              
<a href="#imageclose-6302" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6302">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1403371.png" alt="image-6302">
                   </div></a><p class="wp-caption-text">Decreasing FFT slider</p></div>
<p>That&#8217;s pretty good. We can still tell the difference between a 1 and 0 and we&#8217;ve got a really good representation of where each 1 and 0 starts in the time domain.</p>
<p>Let&#8217;s briefly revisit our use of cursors:</p>
<div id="attachment_6369" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6303"><div class="lb-album"><a href="#image-6303"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1404351-300x146.png" alt="Measuring a single pulse" class="size-medium wp-image-6369"><span></span></a></div>              
<a href="#imageclose-6303" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6303">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1404351.png" alt="image-6303">
                   </div></a><p class="wp-caption-text">Measuring a single pulse</p></div>
<p>It&#8217;s hard to be accurate with just a single pulse (15.15Khz?), but we can easily span more than 1 pulse.</p>
<div id="attachment_6370" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6304"><div class="lb-album"><a href="#image-6304"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1406371-300x113.png" alt="Measuring multiple pulses" class="size-medium wp-image-6370"><span></span></a></div>              
<a href="#imageclose-6304" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6304">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1406371.png" alt="image-6304">
                   </div></a><p class="wp-caption-text">Measuring multiple pulses</p></div>
<p>More like 15.58KHz.</p>
<p>If you suspect you&#8217;ve got a <a title="Manchester Encoded" href="https://en.wikipedia.org/wiki/Manchester_code">Manchester Encoded</a> signal (as we seem to have here), you can expand the slider so that each segment covers two pulses.</p>
<div id="attachment_6371" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6305"><div class="lb-album"><a href="#image-6305"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1408071-300x100.png" alt="Cursors used for Manchester Encoding" class="size-medium wp-image-6371"><span></span></a></div>              
<a href="#imageclose-6305" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6305">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_1408071.png" alt="image-6305">
                   </div></a><p class="wp-caption-text">Cursors used for Manchester Encoding</p></div>
<p>As required for Manchester Encoding, each segment includes either a high-to-low transition or a low-to-high transition, but never high-to-high or low-to-low.</p>
<p>That concludes a walkthrough of using inspectrum to look at FSK modulated signals. We&#8217;ve seen how to confirm we have an FSK signal by looking for square wave in the FFT plot &#8211; i.e. a signal that hops between two (or more) distinct frequencies. We showed how to tweak the sliders to get a nice clear view of the signal, trading off resolution in the frequency domain for resolution in the time domain. We used cursors to show we can take measurements of the baudrate of the signal.</p>
<h2>Example 2: ASK/OOK signal</h2>
<p>For this example we use an RF remote for a mains remote.</p>
<p>Having covered how to use inspectrum in the FSK section above, we&#8217;ll go into less detail in this section.</p>
<p>Upon loading the capture file we&#8217;re presented with what looks like 8 repeating signals. We&#8217;ll drill into one of those and try to see the 1&#8242;s and 0&#8242;s:</p>
<div id="attachment_6379" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6306"><div class="lb-album"><a href="#image-6306"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_162655-300x115.png" alt="8 repeating signals?" class="size-medium wp-image-6379"><span></span></a></div>              
<a href="#imageclose-6306" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6306">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_162655.png" alt="image-6306">
                   </div></a><p class="wp-caption-text">8 repeating signals?</p></div>
<p>Adjusting the Power slides as before we can filter out the background noise and more easily see our signal of interest:</p>
<div id="attachment_6380" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6307"><div class="lb-album"><a href="#image-6307"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_162720-300x110.png" alt="Filtering out background noise" class="size-medium wp-image-6380"><span></span></a></div>              
<a href="#imageclose-6307" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6307">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_162720.png" alt="image-6307">
                   </div></a><p class="wp-caption-text">Filtering out background noise</p></div>
<p>Using the zoom feature, we can start to see the 1&#8242;s and 0&#8242;s pretty quickly.</p>
<div id="attachment_6381" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6308"><div class="lb-album"><a href="#image-6308"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_162759-300x117.png" alt="Locating 1' class="size-medium wp-image-6381"><span></span></a></div>              
<a href="#imageclose-6308" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6308">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_162759.png" alt="image-6308">
                   </div></a><p class="wp-caption-text">Locating 1&#8242;s and 0&#8242;s with zoom slider</p></div>
<p>In this case, though, unlike for FSK we&#8217;re not expecting to see a square wave, we&#8217;re expecting to see a single line with gaps in. Which is what we can already see. Furthermore we can start to figure out the 1&#8242;s and the o&#8217;s. Note that the signal above is composed of only the 2 patterns:</p>
<ul>
<li>Short line followed be long gap; or</li>
<li>Long line followed by short gap</li>
</ul>
<p>One is our 1 and the other is our 0. At this stage it doesn&#8217;t really matter which. Only that we&#8217;d be able to describe any signal using 1&#8242;s and 0&#8242;s the way we define them.</p>
<p>This is easier to see if we use the cursor feature:</p>
<div id="attachment_6382" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6309"><div class="lb-album"><a href="#image-6309"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_174402-300x109.png" alt="Using cursors to highlight 1' class="size-medium wp-image-6382"><span></span></a></div>              
<a href="#imageclose-6309" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6309">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_174402.png" alt="image-6309">
                   </div></a><p class="wp-caption-text">Using cursors to highlight 1&#8242;s and 0&#8242;s</p></div>
<p>If you&#8217;ve read the FSK section above, you may have been tempted (as I was) to slide the FFT slider to the left to improve the resolution in the time domain. If you do this, you&#8217;re able to see that the long line is composed for 4 short lines &#8211; of slightly different lengths!  This makes it really hard to spot the pattern being used for a 1 or 0 (unless you already know it). It doesn&#8217;t matter to us how the long or short line are generated. The fact that they aren&#8217;t continuous lines doesn&#8217;t matter and just causes confusion.  So, in this case we&#8217;ve shown that when investigating ASK/OOK signals, it&#8217;s best to start with the FFT slider on the right (limited resolution in the time domain) and only move if to the left if we&#8217;re unable to spot the pattern used for 1&#8242;s and 0&#8242;s.</p>
<div id="attachment_6383" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6310"><div class="lb-album"><a href="#image-6310"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_185835-300x117.png" alt="Confusing patterns found by sliding FFT slider too far" class="size-medium wp-image-6383"><span></span></a></div>              
<a href="#imageclose-6310" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6310">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/Screenshot_20180121_185835.png" alt="image-6310">
                   </div></a><p class="wp-caption-text">Confusing patterns found by sliding FFT slider too far</p></div>
<p>The post <a href="https://portcullislabs.github.io/blog/adventures-in-rf-using-inspectrum-to-analyse-fsk-and-askook-signals/">Adventures in RF: Using Inspectrum to analyse FSK and ASK/OOK signals</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/adventures-in-rf-using-inspectrum-to-analyse-fsk-and-askook-signals/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>JTAG on-chip debugging: Extracting passwords from memory</title>
		<link>https://portcullislabs.github.io/blog/jtag-on-chip-debugging-extracting-passwords-from-memory/</link>
		<comments>https://portcullislabs.github.io/blog/jtag-on-chip-debugging-extracting-passwords-from-memory/#comments</comments>
		<pubDate>Thu, 29 Mar 2018 08:30:55 +0000</pubDate>
		<dc:creator><![CDATA[ISA]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[hardhack]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6160</guid>
		<description><![CDATA[<p>Following on from my colleague&#8217;s post on using UART to root a phone, I look at another of our challenges, whereby sensitive information such as passwords can be extracted from a device&#8217;s memory if physical access to the device is acquired. The goal and target The target device is the BroadLink RM Pro universal remote [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/jtag-on-chip-debugging-extracting-passwords-from-memory/">JTAG on-chip debugging: Extracting passwords from memory</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Following on from my <a title="colleague's post on using UART to root a phone" href="/blog/uart-debugging-rooting-an-ip-phone-using-uart/">colleague&#8217;s post on using UART to root a phone</a>, I look at another of our challenges, whereby sensitive information such as passwords can be extracted from a device&#8217;s memory if physical access to the device is acquired.<span id="more-6160"></span></p>
<h2>The goal and target</h2>
<div id="attachment_6163" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6161"><div class="lb-album"><a href="#image-6161"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig1_broadlinkrmPro-300x240.jpg" alt="BroadLink RM Pro Smart Remote Control" class="size-medium wp-image-6163"><span></span></a></div>              
<a href="#imageclose-6161" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6161">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig1_broadlinkrmPro.jpg" alt="image-6161">
                   </div></a><p class="wp-caption-text">BroadLink RM Pro Smart Remote Control</p></div>
<p>The target device is the BroadLink RM Pro universal remote control designed for home convenience and automation.</p>
<p>This smart remote control can be used to control multiple home appliances through its application. It also allows users to create scenarios whereby multiple actions can be programmed and activated simultaneously. Device setup and functionality is accessed through the BroadLink e-Control application. This application must be running on a device connected to the same Wi-Fi network as the smart remote and the appliance you want to control.</p>
<div id="attachment_6165" style="width: 178px" class="wp-caption aligncenter"><a name="imageclose-6162"><div class="lb-album"><a href="#image-6162"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig2_boradlink_econtrolapp-168x300.png" alt="BroadLink e-Control application" class="size-medium wp-image-6165"><span></span></a></div>              
<a href="#imageclose-6162" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6162">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig2_boradlink_econtrolapp.png" alt="image-6162">
                   </div></a><p class="wp-caption-text">BroadLink e-Control application</p></div>
<p>For the purpose of this challenge, setting up the device is required. In a real scenario, the device would likely already be set up.</p>
<p>Start by connecting the smart remote to a Wi-Fi network and entering the Wi-Fi SSID and Passphrase within the e-Controls application. The application then subsequently tries to locate the device within the network and once it is found, a connection is established.</p>
<p>Now that the smart remote is functional, an attacker who has physical access to the device may attempt to extract configuration or sensitive information loaded in memory. Successfully replicating this attack scenario is the main goal of this challenge.</p>
<h2>Taking a look inside</h2>
<p>The first step is to investigate the internal components of the device, starting by carefully taking apart the unit. There are three easily removable housing screws situated on the underside of the device.</p>
<p>Once opened, we can then identify different points of interest within the device. These can be internal or external ports, the board&#8217;s chips, components, model and serial numbers. Identifying the chip&#8217;s model and serial number is essential and will provide us with the information we need in latter stages.</p>
<div id="attachment_6166" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6163"><div class="lb-album"><a href="#image-6163"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig3_inside_broadlinkrmpro-300x257.jpg" alt="Inside BroadLink RM Pro Smart remote" class="size-medium wp-image-6166"><span></span></a></div>              
<a href="#imageclose-6163" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6163">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig3_inside_broadlinkrmpro.jpg" alt="image-6163">
                   </div></a><p class="wp-caption-text">Inside BroadLink RM Pro Smart remote</p></div>
<p>Looking for ways to communicate with the device is another key step. When working with embedded architectures, the presence of debug interfaces such as UART and JTAG is a common method used to establish serial connectivity to the device.</p>
<h2>JTAG</h2>
<p>Joint Test Action Group or more simply JTAG, is a standardised type of serial communication commonly used by engineers and developers to perform on-board testing or diagnostics of embedded devices, also known as boundary scanning. Another functionality of JTAG, which is seemingly more used today, is CPU level debugging allowing read-write access to registers and memory.</p>
<p>The JTAG interface uses four connection points also known as Test Access Port or TAP. These connection points correspond to four signals:</p>
<ul>
<li>TDI &#8211; Test Data In; this signal represents input data sent to the device</li>
<li>TDO &#8211; Test Data Out, which represents output data from the device</li>
<li>TCK &#8211; Test Clock, used to synchronise data from the TMS and TDI (rising edge of Test Clock) and TDO (falling edge of Test Clock)</li>
<li>TMS &#8211; Test Mode Select; this signal is used to control the state of the TAP controller</li>
<li>TRST &#8211; Test Reset; this is an optional signal used for resetting the TAP controller</li>
</ul>
<h2>Identifying JTAG pinouts</h2>
<p>The implementation of JTAG is non-standardised, which means that the signal pinouts you may encounter will vary between devices. Aside from the standalone JTAG connection points, commonly seen JTAG interfaces may be a part of a 10 pin, 14 pin, 16 or 20 pin header.</p>
<div id="attachment_6167" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6164"><div class="lb-album"><a href="#image-6164"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig4_jtag_pinouts-300x225.jpg" alt="JTAG pinouts" class="size-medium wp-image-6167"><span></span></a></div>              
<a href="#imageclose-6164" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6164">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig4_jtag_pinouts.jpg" alt="image-6164">
                   </div></a><p class="wp-caption-text">JTAG pinouts</p></div>
<p>Looking closely at the device, the five connection points on the corner of the board is the JTAG interface. Using the JTAG&#8217;s debugging functionality should enable us to read and write data stored in memory.</p>
<p>Note: Some devices will have JTAG present but their connections will have been disabled before being released into production.</p>
<p>There are various tools available which can be used to identify JTAG signal pinouts, all of which vary in available features and pricing. Common examples are JTAGenum (for Arduino), JTAGulator and Hydrabus to name a few. For the purpose of this challenge, a JTAGulator is used. The JTAGulator supports a number of functionalities, including both the identification of UART and JTAG pinouts.</p>
<div id="attachment_6170" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6165"><div class="lb-album"><a href="#image-6165"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig5_jtagulator-300x146.jpg" alt="The JTAGulator" class="size-medium wp-image-6170"><span></span></a></div>              
<a href="#imageclose-6165" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6165">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig5_jtagulator.jpg" alt="image-6165">
                   </div></a><p class="wp-caption-text">The JTAGulator</p></div>
<h2>Connecting the JTAGulator</h2>
<p>The JTAGulator is connected to the smart remote starting from the lowest number of channels/pins on the board (CH0-CH4). The lowest numbered pinouts are used due to the brute-force method used by the JTAGulator to identify the signal value for each pinout. Using the lowest pin number decreases the number of permutation to iterate through and ultimately speeds up the identification process.</p>
<div id="attachment_6171" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6166"><div class="lb-album"><a href="#image-6166"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig6_jtagulator_connected-300x271.jpg" alt="JTAGulator connected to the device' class="size-medium wp-image-6171"><span></span></a></div>              
<a href="#imageclose-6166" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6166">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig6_jtagulator_connected.jpg" alt="image-6166">
                   </div></a><p class="wp-caption-text">JTAGulator connected to the device&#8217;s JTAG pins</p></div>
<p>Once connected, you can control using the JTAGulator via USB connection, which will appear as a serial interface. A number of terminal emulators such as PuTTY, Hyperterminal or Minicom can be used to interface with the JTAGulator. In this instance, we will use ‘screen&#8217; utility, which is installed by default on many Linux distributions. It can be used to establish a serial connection to the JTAGulator via the default ttyUSB0 device in Linux machines. The JTAGulator&#8217;s baudrate of 115200 should also be provided like so:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ sudo screen /dev/ttyUSB0 115200
</pre>
<p>Once a serial connection to the JTAGulator is established, pressing the ‘h&#8217; key shows a list of JTAG commands available. The first step is to set the target voltage to 3.3V, which pertains to the voltage required by the microprocessor. 3.3V is commonly used by most chips; however, accurate information regarding the operational voltage can be found by looking through the chip&#8217;s specification sheet. Setting the correct voltage is important as an incorrect voltage could damage or destroy the device. After setting the voltage, the &#8220;Identify JTAG pinout (IDCODE Scan) can be used to identify JTAG pins, which works by reading the device IDs &#8211; specifically, TDO, TMS and TCK signals. To identify the TDI pin, the BYPASS scan is used.</p>
<p>When running the scans, enter the number of channels to use as five; this will allow the JTAGulator to use the connections made channels CH0 to CH4. The scans should complete fairly quickly as there are only five pins exposed in the board, resulting in a lower number of permutations to be made. If the JTAG implementation appears alongside multiple pinouts, this can increase the number of permutations, thus increasing the duration of the scan.</p>
<div id="attachment_6172" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6167"><div class="lb-album"><a href="#image-6167"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig7_jtagulating_identification-300x111.png" alt="Identifying JTAG pinouts (BYPASS scan)" class="size-medium wp-image-6172"><span></span></a></div>              
<a href="#imageclose-6167" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6167">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig7_jtagulating_identification.png" alt="image-6167">
                   </div></a><p class="wp-caption-text">Identifying JTAG pinouts (BYPASS scan)</p></div>
<p>The result of the BYPASS scan show us the location of the signal pinouts on the JTAGulator, which corresponds to the signal pinouts on the smart remote.</p>
<p>You can skip this step entirely if the JTAG pinouts are labelled on the silkscreen print on the board, so do not forget to check both sides of the PCB, as it may save valuable time.</p>
<div id="attachment_6173" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6168"><div class="lb-album"><a href="#image-6168"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig8_jtag_signal_reverse-300x292.jpg" alt="JTAG signal pinouts printed underneath the board" class="size-medium wp-image-6173"><span></span></a></div>              
<a href="#imageclose-6168" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6168">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig8_jtag_signal_reverse.jpg" alt="image-6168">
                   </div></a><p class="wp-caption-text">JTAG signal pinouts printed underneath the board</p></div>
<h2>The Shikra</h2>
<p>In order for us to get debug access on the smart remote, an interface and some form of OCD (On Chip Debugger) is required. Many devices on the market allow interfacing with JTAG to facilitate on chip debugging, such as Bus Pirate, Shikra and HydraBus. For this scenario, the Shikra and OpenOCD software are used.</p>
<p>The Shikra is an FT232H USB device sometimes referred to as the &#8220;Swiss army knife of hardware hacking&#8221;; this device allows us to connect to a number of data interfaces, including UART, JTAG and SPI. A Shikra can be purchased from Xipiter: <a href="https://int3.cc/products/the-shikra">https://int3.cc/products/the-shikra</a>.</p>
<div id="attachment_6174" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6169"><div class="lb-album"><a href="#image-6169"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig9_shikra-300x168.jpg" alt="The Shikra" class="size-medium wp-image-6174"><span></span></a></div>              
<a href="#imageclose-6169" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6169">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig9_shikra.jpg" alt="image-6169">
                   </div></a><p class="wp-caption-text">The Shikra</p></div>
<p>The following diagram shows the Shikra pinouts for JTAG, which will be used to connect to the board&#8217;s corresponding JTAG pinouts. Ensure that the ground (GND) pin is also connected to a ground point on the board.</p>
<div id="attachment_6190" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6170"><div class="lb-album"><a href="#image-6170"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig10_shikra_jtag_connections-300x231.png" alt="Shikra JTAG connections http://www.xipiter.com/uploads/2/4/4/8/24485815/shikra_documentation.pdf" class="size-medium wp-image-6190"><span></span></a></div>              
<a href="#imageclose-6170" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6170">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig10_shikra_jtag_connections.png" alt="image-6170">
                   </div></a><p class="wp-caption-text">Shikra JTAG connections http://www.xipiter.com/uploads/2/4/4/8/24485815/shikra_documentation.pdf</p></div>
<div id="attachment_6191" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6171"><div class="lb-album"><a href="#image-6171"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig11_shikra_to_usb-300x228.jpg" alt="The Shikra giving serial to USB connectivity" class="size-medium wp-image-6191"><span></span></a></div>              
<a href="#imageclose-6171" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6171">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig11_shikra_to_usb.jpg" alt="image-6171">
                   </div></a><p class="wp-caption-text">The Shikra giving serial to USB connectivity</p></div>
<h2>OpenOCD</h2>
<p>OpenOCD allows us to perform on-chip debugging of the smart remote via JTAG using GDB. In Linux-based systems, you can install the OpenOCD package by running the following command:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ sudo apt-get install openocd
</pre>
<p>In order for us to use OpenOCD, a configuration file for the interface (Shikra) and the target (Smart remote) are required. OpenOCD comes with a number of pre-installed interface and target configuration files; however, the one required does not come in the pre-installed list. The configuration file for the adapter can be found in Xipiter&#8217;s <a title="getting started guide for the Shikra" href="http://www.xipiter.com/musings/using-the-shikra-to-attack-embedded-systems-getting-started">getting started guide for the Shikra</a>.</p>
<p>Shikra OpenOCD configuration file:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
#shikra.cfg
interface ftdi
ftdi_vid_pid 0x0403 0x6014

ftdi_layout_init 0x0c08 0x0f1b
adapter_khz 2000
#end shikra.cfg
</pre>
<p>Obtaining the configuration file for the target was not as straight forward. The configuration file required was not available within the pre-installed configuration files and attempting to use any of them results in compatibility errors with the device.</p>
<p>The approach taken in identifying the appropriate target configuration file involved looking up the microprocessor&#8217;s make and model. Using a magnifying glass or a good enough camera, the specific chip printings can be determined. The chip in question is a Marvell 88MC200 and a simple Google search of this chip and the keyword OpenOCD returns the <a title="target configuration" href="http://openocd.zylin.com/#/c/2553/2/tcl/target/mc200.cfg">target configuration</a> needed.</p>
<pre class="brush: bash; highlight: [7]; title: ; notranslate">
#
# Marvell's Wireless Microcontroller Platform (88MC200)
#
# https://origin-www.marvell.com/microcontrollers/wi-fi-microcontroller-platform/
#

#source [find interface/ftdi/mc200.cfg]

if &quot; [info exists CHIPNAME] &quot; &quot;
   set  _CHIPNAME $CHIPNAME
&quot; else &quot;
   set  _CHIPNAME mc200
&quot;

set  _ENDIAN little

# Work-area is a space in RAM used for flash programming
# By default use 16kB
if &quot; [info exists WORKAREASIZE] &quot; &quot;
   set  _WORKAREASIZE $WORKAREASIZE
&quot; else &quot;
   set  _WORKAREASIZE 0x4000
&quot;

# JTAG scan chain
if &quot; [info exists CPUTAPID ] &quot; &quot;
   set _CPUTAPID $CPUTAPID
&quot; else &quot;
   set _CPUTAPID 0x4ba00477
&quot;

jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_CPUTAPID

set _TARGETNAME $_CHIPNAME.cpu
target create $_TARGETNAME cortex_m -endian $_ENDIAN -chain-position $_TARGETNAME
$_TARGETNAME configure -work-area-phys 0x2001C000 -work-area-size $_WORKAREASIZE -work-area-backup 0

# Flash bank
set _FLASHNAME $_CHIPNAME.flash
flash bank $_FLASHNAME mrvlqspi 0x0 0 0 0 $_TARGETNAME 0x46010000

# JTAG speed should be &lt;= F_CPU/6. F_CPU after reset is 32MHz
# so use F_JTAG = 3MHz
adapter_khz 3000
adapter_nsrst_delay 100
if &quot;[using_jtag]&quot; &quot;
 jtag_ntrst_delay 100
&quot;

if &quot;![using_hla]&quot; &quot;
   # if srst is not fitted use SYSRESETREQ to
   # perform a soft reset
   cortex_m reset_config sysresetreq
&quot;</pre>
<p>The above configuration file was pointing to an interface path (line 7) which in our case was not required and therefore has been commented out. The interface configuration file previously downloaded will be used instead and the file location specified as a command line argument in OpenOCD.</p>
<p>Once both target and interface configuration files are saved locally, run the following OpenOCD command:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ openocd -f /usr/share/openocd/scripts/interface/shikra.cfg -f /usr/share/openocd/scripts/target/mc200.cfg
</pre>
<p>The file path points to shikra.cfg file, which contains the interface configuration and mc200.cfg contains the target board configuration.</p>
<p>The on-chip debugger should now be running as a server and will open local port 4444 on your system. You can then simply connect to this port with Telnet:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ telnet localhost 4444
</pre>
<h2>Dumping the device memory</h2>
<p>Once connected, debug access to the board is now possible and allows control of registers and memory address.</p>
<p>Before the registers can be accessed, sending a halt request is required to send the target into a debugging state. After sending the halt request, the reg command is used to view all of the available registers and its values on the device&#8217;s CPU. The full list of useful commands is available in the <a title="OpenOCD documentation" href="http://openocd.org/doc/html/General-Commands.html">OpenOCD documentation</a>.</p>
<div id="attachment_6192" style="width: 212px" class="wp-caption aligncenter"><a name="imageclose-6172"><div class="lb-album"><a href="#image-6172"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig12_register_values-202x300.png" alt="Registers values shown in OpenOCD" class="size-medium wp-image-6192"><span></span></a></div>              
<a href="#imageclose-6172" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6172">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig12_register_values.png" alt="image-6172">
                   </div></a><p class="wp-caption-text">Registers values shown in OpenOCD</p></div>
<p>Highlighted in the above image is the Stack Pointer (SP) register. Discussing how computer addressing works is beyond the scope of this blog (it is not a simple subject!). For now, it is enough to understand that the location of the Stack Pointer contains the last value pushed onto the stack of things in memory (RAM), serving as the starting address from where user space memory can be accessed.</p>
<p>Going back to the original goal of extracting sensitive information from the device, the &#8220;dump_image&#8221; command can be used to dump memory content (in hex). To successfully dump as much information as possible, a trial and error approach to identify the boundaries of user space memory can be taken.</p>
<p>The dump_image command can be used as follows:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ dump_image img_out2 0x20002898 120000
</pre>
<p>The img_out2 argument is the output filename; the next argument is the Stack Pointer address and finally the amount of memory to dump in bytes.</p>
<div id="attachment_6193" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6173"><div class="lb-album"><a href="#image-6173"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig13_duming_to_file-300x112.png" alt="Dumping memory to a file" class="size-medium wp-image-6193"><span></span></a></div>              
<a href="#imageclose-6173" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6173">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig13_duming_to_file.png" alt="image-6173">
                   </div></a><p class="wp-caption-text">Dumping memory to a file</p></div>
<p>The image above shows that initial attempts at dumping memory may fail if a larger amount of bytes than what is available is specified.</p>
<p>After successfully dumping the contents of memory in hex, an analysis of the file can be performed to identify any information that might be of interest.</p>
<div id="attachment_6194" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6174"><div class="lb-album"><a href="#image-6174"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig14_wifi_passphrase-300x191.png" alt="Wi-Fi passphrase next to the SSID" class="size-medium wp-image-6194"><span></span></a></div>              
<a href="#imageclose-6174" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6174">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/fig14_wifi_passphrase.png" alt="image-6174">
                   </div></a><p class="wp-caption-text">Wi-Fi passphrase next to the SSID</p></div>
<p>A hex editor of your choice can be used to navigate around the contents of the file and in the example above, we have used Ghex. Looking around the file and by performing a quick search, we can see the SSID name the device is connected to. 18 bytes after it, the passphrase was also shown.</p>
<p>If we had purchased this device second-hand, then we could potentially use it to access someone&#8217;s home network and launch further attacks.</p>
<h2>Conclusion</h2>
<p>Cyber attacks on smart home devices should now be recognised by home consumers, as well as the risks posed should these devices be sold or stolen. On the other hand, manufacturers should consider methods for securing the hardware aspect &#8211; the very foundation of these devices &#8211; to ensure the security and privacy of its users.</p>
<p>Cisco&#8217;s hardware hacking challenges gives us the opportunity to learn different methods to tamper or attack a device, therefore promoting a greater understanding of the security risks and controls they present. This post has presented a simple proof-of-concept attack on a consumer smart device, whereby a user&#8217;s Wi-Fi passphrase can be extracted and therefore allow an attacker to achieve persistent access to a victim&#8217;s network. This type of attack can be prevented by disabling &#8211; or more effectively &#8211; removing the JTAG ports completely from production devices, thereby minimising its attack surface.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/jtag-on-chip-debugging-extracting-passwords-from-memory/">JTAG on-chip debugging: Extracting passwords from memory</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/jtag-on-chip-debugging-extracting-passwords-from-memory/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>UART Debugging: Rooting an IP Phone using UART</title>
		<link>https://portcullislabs.github.io/blog/uart-debugging-rooting-an-ip-phone-using-uart/</link>
		<comments>https://portcullislabs.github.io/blog/uart-debugging-rooting-an-ip-phone-using-uart/#comments</comments>
		<pubDate>Fri, 23 Mar 2018 09:07:45 +0000</pubDate>
		<dc:creator><![CDATA[DLZ]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[hardhack]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6220</guid>
		<description><![CDATA[<p>In this post I share my solution to an internal hacker challenge relating to identifying the UART pins on a VOIP phone and using them to gain root access. UART (Universal Asynchronous Receiver-Transmitter) is a hardware device that is used for serial communications. It comes in the form of a physical circuit or as a [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/uart-debugging-rooting-an-ip-phone-using-uart/">UART Debugging: Rooting an IP Phone using UART</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>In this post I share my solution to an <a href="/blog/hardware-hacking-how-to-train-a-team/" title="internal hacker challenge">internal hacker challenge</a> relating to identifying the UART pins on a VOIP phone and using them to gain root access.<span id="more-6220"></span></p>
<p>UART (Universal Asynchronous Receiver-Transmitter) is a hardware device that is used for serial communications. It comes in the form of a physical circuit or as a standalone integrated circuit. UART is used to transmit and receive serial data and is very commonly included in the microcontrollers for the purposes of testing.</p>
<h2>Figuring out the pinout, baud rate and rooting the device</h2>
<p>UART uses two wires to transmit and receive, which connect to Tx and Rx pins. However, UART is very commonly seen in a group of three pins. The third pin in UART is usually the ground pin.</p>
<p>Before you start identifying the baud rate, you need to identify the correct pinout. You can use a multi-meter to do that. First thing we need to do is to identify points of interest. UART usually consists of two pins, so we need to identify where on the board UART could possibly be.</p>
<div id="attachment_6230" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6221"><div class="lb-album"><a href="#image-6221"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/uart-board-300x208.png" alt="Inside of the Yealink SIP-T20P IP Phone" class="size-medium wp-image-6230 aligncenter"><span></span></a></div>              
<a href="#imageclose-6221" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6221">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/uart-board.png" alt="image-6221">
                   </div></a><p class="wp-caption-text"><strong>Inside of the Yealink SIP-T20P IP Phone</strong></p></div>
<p>Above is an image of the PCB of a Yealink SIP-T20P IP Phone. We can see that this board contains two sets of pins in the bottom left corner of the board. As we know, UART consists of two pins, so we can safely say that the pins on the left could be what we are looking for:</p>
<div id="attachment_6232" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6222"><div class="lb-album"><a href="#image-6222"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/uart-con-closeup-300x173.png" alt="Points of interest" class="size-medium wp-image-6232"><span></span></a></div>              
<a href="#imageclose-6222" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6222">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/uart-con-closeup.png" alt="image-6222">
                   </div></a><p class="wp-caption-text"><strong>Points of interest</strong></p></div>
<p>Traces are those lines that go from the microcontroller to the pins. The dark green part is the isolation bit and the part in-between the isolation is where the copper trace runs and connect the pins to the microcontroller.</p>
<div id="attachment_6246" style="width: 264px" class="wp-caption aligncenter"><a name="imageclose-6223"><div class="lb-album"><a href="#image-6223"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/uart-traces.png" alt="UART traces" class="size-full wp-image-6246"><span></span></a></div>              
<a href="#imageclose-6223" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6223">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/uart-traces.png" alt="image-6223">
                   </div></a><p class="wp-caption-text"><strong>UART traces</strong></p></div>
<p>Now that we know where our UART pins are, the next job is to figure out which pins are Ground, Tx and Rx. There are many ways that this can be done. Firstly, we need to identify the Ground pin. In the image below, we can clearly see that the middle pin and right pin are connected to traces, so we can assume that these are the Tx and Rx pins of UART. The Ground pin can be easily identified as it will not have any traces going towards it. In this case, the Ground pin is the pin on the left, as we can clearly see that there is no trace going towards it &#8211; it is directly connected to the ground plane.</p>
<div id="attachment_6231" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6224"><div class="lb-album"><a href="#image-6224"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/uart-closeup-300x213.png" alt="UART pins" class="size-medium wp-image-6231"><span></span></a></div>              
<a href="#imageclose-6224" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6224">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/uart-closeup.png" alt="image-6224">
                   </div></a><p class="wp-caption-text"><strong>UART pins</strong></p></div>
<p>Once we have identified the Ground pin, we need to identify the Tx and Rx pins. This can be done in many different ways. One of these ways is very easy, and regards basically guessing the pins. There is a 50/50 chance that you will get it right, so if it does not work the first time, you can just change the pinout and it should work.</p>
<p>Another way of identifying the Tx and Rx pins is to use a specialist tool, such as a JTAGulator. JTGAulator will be able to tell exactly which pin is which.</p>
<div id="attachment_6229" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6225"><div class="lb-album"><a href="#image-6225"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/jtagulator-300x194.png" alt="The JTAGulator" class="size-medium wp-image-6229"><span></span></a></div>              
<a href="#imageclose-6225" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6225">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/jtagulator.png" alt="image-6225">
                   </div></a><p class="wp-caption-text"><strong>The JTAGulator</strong></p></div>
<p>Above is a image of a JTAGulator. JTAGulator has a set of connectors which can be used to find out the UART pinout, provide UART pass-through, connect JTAG, etc. In order to use it, we need to connect it to a USB port on our laptop to provide power. Once we do that, we use jump wires to connect the JTAGulator to our UART pins. JTAGulator connectors are all labelled starting from GND (Ground) pin, VADJ pin, and CH (Channel) pins, which range from 0 to 7.</p>
<div id="attachment_6227" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6226"><div class="lb-album"><a href="#image-6226"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/jtagulator-closeup-300x240.png" alt="Picture showing The JTAGulator testing pins" class="size-medium wp-image-6227"><span></span></a></div>              
<a href="#imageclose-6226" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6226">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/jtagulator-closeup.png" alt="image-6226">
                   </div></a><p class="wp-caption-text"><strong>Picture showing The JTAGulator testing pins</strong></p></div>
<p>In order for the JTAGulator to work, we need to connect the pins correctly, so GND to GND, and Channels 0 and 1 to what we think are the Tx and Rx pins. Once finished, it should look like this:</p>
<div id="attachment_6228" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-6227"><div class="lb-album"><a href="#image-6227"><img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/jtagulator-connected-300x197.png" alt="The JTagulator connected to the UART pins of the IP Phone" class="size-medium wp-image-6228"><span></span></a></div>              
<a href="#imageclose-6227" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6227">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2018/01/jtagulator-connected.png" alt="image-6227">
                   </div></a><p class="wp-caption-text"><strong>The JTagulator connected to the UART pins of the IP Phone</strong></p></div>
<p>Once the wires are connected, we need to find the correct baud rate in order to specify the rate at which bits are transmitted to get a human readable output. If baud rate is mismatched, the data can be either misinterpreted or completely missed. There are many different ways to figure out the Baud Rate of different boards. One way is to basically just guess the baud rate. There are several typically-used baud rates, such as 110, 300, 600, 1200, 2400, 4800, 9600, 14400, 19200, 38400, 57600, 115200, 128000 and 256000 bits per second. Basically, connect the device and try those different baud rates until you get readable output is also a way of figuring out the baud rate.</p>
<p>Another way of figuring out the baud rate is to use an oscilloscope. In order to do that, we need to connect our oscilloscope to the Tx pin and then set our oscilloscope to trigger a pulse. Once this is done, we then measure the time of the shortest pulse and the reciprocal of that pulse is the baud rate. To provide an example, if our shortest pulse is 100µs, then our baud rate will be 1/(100 * 10^-6) = 10,000. As 10,000 is not a real baud rate, we round it to the closest possible baud rate which is 9,600 and there we have our baud rate.</p>
<p>Using JTAGulator is another way of finding out the baud rate and pinout. Once we have the JTAGulator connected to our laptop, we need to communicate with it. JTAGulator is using a USB for power and connection, so we need to be able to achieve serial communication with the device. This can be achieved by using a screen tool on Linux, or putty on Windows. We used Debian, so the tool we used for serial communications was screen. Therefore, in order to establish serial communication, we run the command below:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ sudo screen /dev/tty.usbserial-AL024BCV 115200
</pre>
<p>The command above can be used to establish serial communication with our JTAGulator device. The command screen invokes the tool; the next part of it is where we specify the device to connect to &#8211; /dev is a directory in Linux where we can find all devices that are currently connected to our machine. A ttyUSB0 is the name of our JTAGulator device and the number after it is the baud rate. The baud rate can be found in the JTAGulator documentation. When we run this command, we will end up with a connection to JTAGulator:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
:h
JTAG Commands:
I   Identify JTAG pinout (IDCODE Scan)
B   Identify JTAG pinout (BYPASS Scan)
D   Get Device ID(s)
T   Test BYPASS (TDI to TDO)

UART Commands:
U   Identify UART pinout
P   UART passthrough

General Commands:
V   Set target I/O voltage (1.2V to 3.3V)
R   Read all channels (input)
W   Write all channels (output)
J   Display version information
H   Display available commands
</pre>
<p>Now that we have established our serial communication with the JTAGulator, the first thing we need to do is to set the I/O voltage. If you try to do anything without setting the I/O voltage first, the device will prompt you to set the voltage. To set the voltage on the JTAGulator, we press V and then Enter. This will prompt us to select a set a voltage ranging from 1.2V to 3.3V. In this case, we have set the voltage to be 3.3V. The voltage needed to transmit data though the pins is usually contained within a datasheet of the device. However, 3.3V is a commonly used voltage in bigger chips. Smaller chips might use a voltage of 1.2V. It is essential to select a correct voltage. If the voltage is too big, it can damage the chip. On the other hand, if the voltage is too low, it can damage the device that is trying to communicate with the chip (in this case, the JTagulator).</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
:v
Current target I/O voltage: Undefined
Enter new target I/O voltage (1.2 - 3.3, 0 for off): 3.3
New target I/O voltage set: 3.3
Ensure VADJ is NOT connected to target!
:
</pre>
<p>Once the voltage is set, we can start doing the pinout and baud rate identification. In order to do that, we press U and then enter. The JTAGulator will then prompt us for some information regarding the pinout identification such as:</p>
<ul>
<li>Text String to Output &#8211; This is the string that will be used to test different baud rates and based on the output we will be able to identify the correct one if the string is outputted the same. In this case, we will be using a string &#8220;test&#8221;</li>
<li>Number of Channels &#8211; Number of channels is used to determine how many pins we are going to be using for the pinout identification. There is a maximum of 24 channels, 8 on each set of pins on our JTGAulator. In this scenario, we are doing UART which has only three pins and only two that are used for communications, so the number of channels that we are going to need is two. More channels may be required, however, when trying to identify JTAG pinout, for example</li>
</ul>
<pre class="brush: bash; gutter: false; title: ; notranslate">
:U
Enter text string to output (prefix with \x for hex) [CR]: test
Enter number of channels to use (2 - 24): 2
Ensure connections are on CH1..CH0.
Possible permutations: 2
Press spacebar to begin (any other key to abort)...
</pre>
<p>Now that we have got our parameters setup, we can start enumeration of the pinout and the baud rate. In order to begin, we need to press the spacebar and the JTAGulator will iterate through possible combinations of the pinout and baud rate:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
TXD: 1
RXD: 0
Baud: 1200
Data: ..... [ FF FF FF FF FF ]

TXD: 1
RXD: 0
Baud: 1800
Data: .... [ FF FD FD FD ]

TXD: 1
RXD: 0
Baud: 2400
Data: ... [ FD F5 FD ]

TXD: 1
RXD: 0
Baud: 3600
Data: 9.9 [ 39 FF 39 ]

TXD: 1
RXD: 0
Baud: 4800
Data: .. [ F0 FA ]

TXD: 1
RXD: 0
Baud: 7200
Data: .. [ 8C B0 ]

TXD: 1
RXD: 0
Baud: 9600
Data: .. [ 00 ED ]

TXD: 1
RXD: 0
Baud: 14400
Data: ic.. [ 69 63 D6 F8 ]

TXD: 1
RXD: 0
Baud: 19200
Data: .....f.`..C.... [ A7 B7 15 19 80 66 B0 60 08 F4 43 9D 0E B9 FE ]

TXD: 1
RXD: 0
Baud: 28800
Data: di.. [ 64 69 DE FF ]

TXD: 1
RXD: 0
Baud: 31250
Data: ...x. [ D4 D6 B6 78 F5 ]

TXD: 1
RXD: 0
Baud: 38400
Data: ..... [ B4 E5 B3 1B F9 ]

TXD: 1
RXD: 0
Baud: 57600
Data: test...starting [ 74 65 73 74 0D 0A 0D 73 74 61 72 74 69 6E 67 20 ]

TXD: 1
RXD: 0
Baud: 76800
Data: tt... [ 74 74 82 8E F8 ]

TXD: 1
RXD: 0
Baud: 115200
Data: .....0. [ 80 80 0C 80 80 30 F8 ]

TXD: 1
RXD: 0
Baud: 153600
Data: ... [ F0 F8 FC ]

TXD: 1
RXD: 0
Baud: 230400
Data: .... [ F8 F8 F8 F8 ]

TXD: 1
RXD: 0
Baud: 250000
Data: .... [ F8 00 F0 F8 ]

TXD: 1
RXD: 0
Baud: 307200
Data: ... [ E0 F0 F0 ]
.
UART scan complete!
:
</pre>
<p>Once we start our iteration, we will see the output of different combinations that the JTAGulator has tested, as in the image above. We will need to go through those and see which one returns the string we have entered as one of our parameters.</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
TXD: 1
RXD: 0
Baud: 57600
Data: test...starting [ 74 65 73 74 0D 0A 0D 73 74 61 72 74 69 6E 67 20 ]
</pre>
<p>In the image above, we have located the correct pinout and baud rate for the Yealink SIP-TP20P IP Phone. So now that we have all the information we need, we can use these to correctly connect the pins and establish serial communication. Again, there are many different tools we can use to do that, such as a USB to Serial Adapter, or even JTAGulator. In this example, we will use the JTGAulator to perform something called UART pass-through. In case someone does not have or cannot afford a JTAGulator, there are other, cheaper solutions available (for example, USB to UART bridge modules or the Bus Pirate). These are USB sticks with UART connectors that allow a bi-directional link between USB bus and UART serial bus.</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
UART Commands:
U Identify UART pinout
P UART passthrough
</pre>
<p>In order for us to perform a UART pass-through using the JTAGulator, we need to press P and then enter. This will prompt us to give some information which we have collected in the previous task. Once we enter the UART pass-through mode, JTAGulator will ask us for the channel numbers of the Tx and Rx pins. So based on the information we collected, we know that the Tx pin is connected to channel 1 and the Rx pin is connected to channel 0. Once we supply the pin information, we will then be asked to supply the baud rate. As we know from the previous task, the baud rate is 57,600.</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
:p
Enter new TXD pin [0]: 1
Enter new RXD pin [0]: 0
Enter new baud rate [0]: 57600
Enable local echo? [y/N]:
Entering UART passthrough! Press Ctrl-X to abort...
</pre>
<p>Once we enter this information, we can establish a UART pass-through. In this particular case, the device does not provide any security measures and as soon as you connect, you get through a booting process. To get to a root shell, the device must not be connected to the network, as right after the DHCP fails, you need to press enter and you get dropped into a root shell.</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
#
# id
uid=0(root) gid=0(root)
#
</pre>
<p>In the <a title="next part" href="/blog/jtag-on-chip-debugging-extracting-passwords-from-memory/">next part</a> of this series, we will cover how another of the Team tackled the JTAG challenge.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/uart-debugging-rooting-an-ip-phone-using-uart/">UART Debugging: Rooting an IP Phone using UART</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/uart-debugging-rooting-an-ip-phone-using-uart/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Hardware hacking: How to train a team</title>
		<link>https://portcullislabs.github.io/blog/hardware-hacking-how-to-train-a-team/</link>
		<comments>https://portcullislabs.github.io/blog/hardware-hacking-how-to-train-a-team/#comments</comments>
		<pubDate>Fri, 09 Mar 2018 00:28:42 +0000</pubDate>
		<dc:creator><![CDATA[ACD]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[hardhack]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=5930</guid>
		<description><![CDATA[<p>This is the first in a proposed series of blog posts that plan to give an insight into the ways we devised to train up our team in hardware hacking tools and techniques. This first post acts as an introduction to the regime to show off each of the challenges we set up to train [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/hardware-hacking-how-to-train-a-team/">Hardware hacking: How to train a team</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>This is the first in a proposed series of blog posts that plan to give an insight into the ways we devised to train up our team in hardware hacking tools and techniques. This first post acts as an introduction to the regime to show off each of the challenges we set up to train our team in the basics of hardware hacking. Subsequent posts will focus on how to solve some of the actual challenges used to train our consultants.<span id="more-5930"></span></p>
<p>It is difficult to find freely available material around the web that takes a person from zero (or almost zero) knowledge up to a competent &#8220;hardware hacker&#8221;. There are plenty of individual resources for specific hardware out there, but they generally follow a walkthrough of what was done in that specific case and do not necessarily open the mind of the person following the guide on how to make those discoveries for themselves, or teach them to adapt to differing scenarios. The main hurdle is that this is a skill that requires physical devices and tools, which means investment. It also means trying to figure out exactly what hardware to buy and not necessarily having guarantees that it is interesting hardware or still available.</p>
<p>This was a problem we came up against for training up our own team. Sure, we could send people on intensive training courses, but that is not always feasible and places limits on who can join in; it is also possibly too much for someone who wants to &#8216;test the waters&#8217; to see if hardware hacking is something they are passionate about.</p>
<p>The problem came about when we realised only a subset of people knew &#8216;hardware hacking&#8217;, despite interest from other members of the Team, and that people could not really &#8216;get involved&#8217; easily without specific training sessions. Our solution was to set about developing our own internal training regime that is largely self-contained. Since it has been successful internally, we have decided to share the fundamentals of it with the wider world, so others can build on this foundation and join in with the hardware fun!</p>
<h2>The training regime</h2>
<p>The overarching approach for our training regime is relatively straightforward: provide the technical theory behind something and then have the learner apply that practically. Then repeat until a good enough general understanding of hardware is achieved, so that given an unknown (i.e. purchase of a random device to play with or a customer-facing engagement), the individual would know how to approach the assessment based off past experience of both security consultancy in general, and applied hardware knowledge.</p>
<p>So really, it is just the tried and true &#8216;theory-practical&#8217; approach, working from the basics up to more complicated endeavors.</p>
<p>At a really high level, the training regime looks like this:</p>
<div id="attachment_6211" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-5931"><div class="lb-album"><a href="#image-5931"><img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/training-regime-300x62.png" alt="Training plan" class="aligncenter size-medium wp-image-6211"><span></span></a></div>              
<a href="#imageclose-5931" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5931">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/training-regime.png" alt="image-5931">
                   </div></a><p class="wp-caption-text">Training plan</p></div>
<p>To achieve skills in each of the above, we have a decent selection of largely &#8216;random&#8217; hardware, ranging from old production equipment, cheap items purchased specifically for our team to practice on, and even donated items. These devices have been played with and then &#8216;challenges&#8217; formed from them, each focusing on a specific attack vector. Here is a &#8211; pretty terrible &#8211; collage of some of the hardware devices we use for training purposes:</p>
<div id="attachment_5970" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-5932"><div class="lb-album"><a href="#image-5932"><img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/ALL-THE-THINGS-300x293.png" alt="Collage of hardware" class="aligncenter size-medium wp-image-5970"><span></span></a></div>              
<a href="#imageclose-5932" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5932">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/ALL-THE-THINGS.png" alt="image-5932">
                   </div></a><p class="wp-caption-text">Collage of hardware</p></div>
<p>An astute hardware hacker may notice many of the devices are indeed of the cheaper off-brand variety. This is intentional for both cost purposes (especially replacement) and because they are usually easier to train people on, due to the more spartan and utilitarian design (cost efficiency) of cheap devices.</p>
<p>While we do not set a strict timeline, we try and give those coming from a zero hardware knowledge background a week to finish the initial training challenges and any associated research/reading required to complete them. We then delve into this list below, explaining what each challenge is and the aims and objectives for the learner. Each challenge focuses on a key element of hardware hacking, meaning that by the end of the training the learner has a decent grasp of the basics of hardware hacking and they can go off and research more advanced techniques in their own time.</p>
<p>In addition to the challenges described below, we have a fairly extensive wiki which covers the basic theory behind each element of the training, which can of course be bolstered by the individual doing their own research to expand on concepts we explain. With the theory in place, they tackle each challenge.</p>
<h2>Hardware basics</h2>
<p>The first foray into hardware hacking starts from first principals to teach some of the required core skills, such as:</p>
<ul>
<li>Initial device disassembly</li>
<li>Reading a PCB &#8211; understanding components, layers and traces, silkscreen, markings, etc.</li>
<li>Identifying points of interest &#8211; chip identification, basic searching techniques and pinouts/headers identification</li>
<li>Individual pin identification (especially ground) and basic multimeter use (continuity and resistance testing)</li>
<li>Basic electronics and safety &#8211; i.e. do not hold a board with fingers lodged around capacitors near the power input whilst a device is powered on (not that anyone on our team has ever done such a thing *cough*)</li>
<li>Google Fu &#8211; this is especially useful in searching for things like datasheets for chip pinouts, available debug interfaces, etc.</li>
</ul>
<h3>The challenge</h3>
<p>After reading the basics training, the related challenge involves giving an &#8216;unidentified&#8217; hardware device to an individual and asking them to threat model it, or put more simply, &#8216;tell us about it&#8217;. As expected, it roughly involves identifying and enumerating everything possible regarding the device: its features, components, datasheets, pinouts, what might be of interest to attack and how.</p>
<p>For our challenge, we use a board once used as part of an access control system which has had any immediately identifiable labels removed, such as the one below:</p>
<div id="attachment_5971" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-5933"><div class="lb-album"><a href="#image-5933"><img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/identification-challenge-front-300x200.jpg" alt="Component dentification challenge" class="aligncenter size-medium wp-image-5971"><span></span></a></div>              
<a href="#imageclose-5933" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5933">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/identification-challenge-front.jpg" alt="image-5933">
                   </div></a><p class="wp-caption-text">Component identification challenge</p></div>
<h2>UART training</h2>
<p>UART (Universal Asynchonous Receive/Transmit) is a really simple interface to work with and if you are lucky enough to find the right device, it can be an easy win. It is also a relatively simple interface to talk to/get working &#8211; it is generally only a receive pin and a transmit pin (alongside ground of course). All that is required in addition is some sort of serial to USB adaptor (these are cheap), some jumper wires of the right kind and an application to talk over the USB-serial interface (screen, minicom, putty, etc).</p>
<p>For these reasons, we think it makes a great introduction to the &#8216;hands on&#8217; part of hardware hacking, without too much complexity or struggling to figure out whether or not wires are connected properly or software has gone wrong. It can help build confidence in connecting things to boards without too many hurdles or complexities to consider. So essentially, the following is taught:</p>
<ul>
<li>Pin identification</li>
<li>Pin connection techniques</li>
<li>Serial-USB knowledge</li>
<li>Basic multimeter use (mainly to identify ground and follow traces)</li>
<li>The requirement for patience and trial and error. Quite often, connecting pins correctly can be fiddly</li>
</ul>
<h3>The challenge</h3>
<p>The objective of our basic UART challenge is to identify, enumerate (figure out baud rate and pinout) and then connect to UART and get a root shell on an old VoIP phone. As the first hands-on session, the device we chose gives up its root shell very easily, once the correct connections are made.</p>
<div id="attachment_5968" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-5934"><div class="lb-album"><a href="#image-5934"><img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/uart-300x168.jpg" alt="UART challenge" class="aligncenter size-medium wp-image-5968"><span></span></a></div>              
<a href="#imageclose-5934" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5934">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/uart.jpg" alt="image-5934">
                   </div></a><p class="wp-caption-text">UART challenge</p></div>
<p>A more advanced version of the challenge regards some modifications that are needed to &#8216;get access&#8217; via UART is planned, but that is very device specific and we are waiting to obtain a good device that would make a compelling challenge.</p>
<h2>JTAG training</h2>
<p>JTAG (Joint Task Action Group &#8211; yes the standard is named after the group who made it) is a good next-step in learning how to connect to points on a board. It is another serial debugging interface of sorts. It usually requires a bit more enumeration at the outset, due to the presence of more pins, but this can be easily tackled with the right equipment. On top of learning how to use some basic hardware tools, the real strength of JTAG is the potential for some on-chip/in memory debugging. Overall, for JTAG, we try to teach:</p>
<ul>
<li>Identifying and understanding JTAG</li>
<li>JTAG pinout</li>
<li>Using some basic hardware tools for enumeration (such as a JTAGulator or some other microcontroller running JTAGEnum)</li>
<li>Basic on-chip/memory debugging via JTAG using OpenOCD and devices like the BusPirate and the Shikra as interfaces</li>
</ul>
<h3>The challenge</h3>
<p>The challenge covers the points outlined above and is designed to build confidence in interfacing with boards at a hardware level. It involves locating and determining the pinout of a JTAG interface on a smart home controller, then enumerating the pinout using suitable hardware, followed by using OpenOCD with a suitable profile (which may require some google-fu). Finally, the user has to find and extract some specific data from memory to show the challenge has been completed.</p>
<p>The below is a picture of the board we use for training. Can you spot the JTAG interface?</p>
<div id="attachment_5969" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-5935"><div class="lb-album"><a href="#image-5935"><img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/jtag-basics-challenge-front-300x200.jpg" alt="JTAG-smart-home-controller" class="aligncenter size-medium wp-image-5969"><span></span></a></div>              
<a href="#imageclose-5935" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5935">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/jtag-basics-challenge-front.jpg" alt="image-5935">
                   </div></a><p class="wp-caption-text">JTAG challenge</p></div>
<h2>Pulling and rewriting/reversing firmware OTA (Over the air)</h2>
<p>This part of the training focuses on some of the more software-focused skills and dealing with small embedded devices, specifically, it aims to teach:</p>
<ul>
<li>Familiarity of working with a small embedded device</li>
<li>Performing &#8220;Man-In-The-Middle&#8221; attacks on an over-the-air (OTA) firmware update</li>
<li>Simple modification of a firmware binary</li>
<li>Subversion of simple firmware protection techniques</li>
</ul>
<p>Alongside this, skills for standard web application techniques in the context of IoT devices are also used/required, but not taught as part of our hardware hacking training.</p>
<h3>The challenge</h3>
<p>The objective is to rewrite the firmware on the device. This involves performing a MitM (&#8220;Man-In-The-Middle&#8221;) attack on an OTA firmware update, followed by grabbing the firmware from the server, reverse engineering it, figuring out where the protection is and subverting it. At this point, the trainee has to find a way to force the device to load a modified version of firmware.</p>
<p>For this challenge, we use a small ESP 8266 styled microcontroller running a simple web server which could used for firmware updates, alongside a separate server hosted on our own network which is used to deliver the firmware update.</p>
<p>8266&#8242;s look like this and are easy to both write firmware for and to configure with something like esptool:</p>
<div id="attachment_6209" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-5936"><div class="lb-album"><a href="#image-5936"><img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/IMG_20180108_173645-300x224.jpg" alt="ESP 8266 OTA update challenge" class="aligncenter size-medium wp-image-6209"><span></span></a></div>              
<a href="#imageclose-5936" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5936">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/IMG_20180108_173645.jpg" alt="image-5936">
                   </div></a><p class="wp-caption-text">ESP 8266 OTA update challenge</p></div>
<h2>SPI flash training</h2>
<p>Learning about SPI can open up a world of information gathering and modification to a hardware hacker, but it can be fiddly to get to grips with. We aim to teach:</p>
<ul>
<li>Tools and techniques to extract SPI flash, primarily via the BusPirate</li>
<li>Learn how to read SPI flash contents</li>
<li>SPI flash modification</li>
</ul>
<p>Soldering and de-soldering are covered in separate training.</p>
<h3>The challenge</h3>
<p>For this challenge, we use another ESP 8266 microcontroller. This time, however, it is connected to a breadboard with a SPI flash chip mounted separately for easy removal and reconnection. We do this so that we do not end up in a situation where everyone who wishes to do the training has to de-solder (and later reconnect/re-solder) a SPI flash chip at the risk of losing the device, which would be annoying for everyone and fill up a bin of broken hardware.</p>
<p>The challenge requires the trainee to &#8216;dismount&#8217; the SPI chip, and connect it up to their laptop appropriately so that the contents of the chip can be read. The objective is to obtain credentials for the web server hosted on the device. Once obtained, the chip should be remounted and the credentials used to authenticate onto the web application of the ESP 8266 device.</p>
<h2>SDR &amp; RF (Software Defined Radio &amp; Radio Frequency) Training</h2>
<p>This part of the training regime focuses on radio wave bands and almost anything wire<br />
less (not including WiFi, as we have a separate service for that). It aims to teach the trainee about the following:</p>
<ul>
<li>Use of SDR software and hardware such as Airspy and SDR#, various SDR dongles, HackRF and so on</li>
<li>Understanding commonly used frequencies and how to monitor them</li>
<li>Capturing and replaying attacks</li>
<li>Understanding some of the most common modulation techniques in-use</li>
</ul>
<h3>The challenge</h3>
<p>The challenge for this training is currently quite simple &#8211; a smart plug which can be turned on and off with a remote and a &#8216;smart&#8217; doorbell. The objective is to find the bands the devices use, capture the traffic and successfully replay the correct sequence to control the devices from a laptop. Primarily, this challenge was designed to get people used to the tool-chain used in these sorts of scenarios.</p>
<p>Here is a picture of the devices. Hiding the doorbell in people&#8217;s belongings and then triggering it when they least expect it has become a fun (annoying) game in our office:</p>
<div id="attachment_6210" style="width: 310px" class="wp-caption aligncenter"><a name="imageclose-5937"><div class="lb-album"><a href="#image-5937"><img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/IMG_20180108_173916-300x224.jpg" alt="RF challenge" class="aligncenter size-medium wp-image-6210"><span></span></a></div>              
<a href="#imageclose-5937" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5937">
                   <img src="https://portcullislabs.github.io/wp-content/uploads/2017/07/IMG_20180108_173916.jpg" alt="image-5937">
                   </div></a><p class="wp-caption-text">RF challenge</p></div>
<h2>Soldering training</h2>
<p>Soldering (and de-soldering) is often required as part of hardware hacking, though it can be fiddly to teach without a lot of time investment.</p>
<p>For our training, we have some devices that are cheap and can be soldered on to &#8211; generally we will teach soldering on pins for connections. But perhaps more appropriately, trainees are encouraged to go and buy a project such as a DIY clock with numerous LEDs and practice on that. We also encourage the use of bread-boarding.</p>
<p>To help with this, we keep some cheap soldering irons (to go along with our more expensive ones, which are reserved for trained hands) in the office. Overall, we attempt to teach the following:</p>
<ul>
<li>All the usual safety stuff</li>
<li>Skills in soldering and de-soldering, primarily chips</li>
<li>Understanding of soldering tools and techniques (flux, solder wire, different types of tips and temperatures, etc.)</li>
<li>Basic bread-boarding and data extraction</li>
<li>Hot air rework station use</li>
<li>Gauge soldering skill, to know who has a deft hand at it (some people simply don not have steady hands; I count myself among them)</li>
</ul>
<p>We do not have a specific challenge to complete this training, instead relying on observing the soldering skills of an individual.</p>
<h2>Next steps</h2>
<p>After completing the training regime challenges, we hope our consultants go out and take apart interesting devices of their own accord (assuming they have permission). To help with this, we have a number of cheap hardware devices which are not part of the training, but make for good fun and practice. When a consultant feels comfortable and has solved enough challenges, they can be considered billable.</p>
<h2>Other ideas</h2>
<p>We have ideas for future improvements to the service, both in terms of training content and challenges. We keep our eyes peeled for interesting or unique devices we come across that we may consider as a more advanced challenge for our team. Devices lying around the office are often disassembled out of curiosity (permission granting). As with any organisation, we have internal pages for trainees to follow, which are continuously being updated by members of the Team.</p>
<p>In the <a title="next part" href="/blog/uart-debugging-rooting-an-ip-phone-using-uart/">next part</a> of this series, one of our recent interns Dan, discusses how he went about solving the UART challenge.</p>
<p>Happy hardware hacking!</p>
<p>The post <a href="https://portcullislabs.github.io/blog/hardware-hacking-how-to-train-a-team/">Hardware hacking: How to train a team</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/hardware-hacking-how-to-train-a-team/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
